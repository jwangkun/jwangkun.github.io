<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="yes" name="apple-mobile-web-app-capable" />
  <meta content="black" name="apple-mobile-web-app-status-bar-style" />
  <meta name="referrer" content="never">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <meta name="author" content="kveln">
  <title>MySQL é«˜å¯ç”¨å¤åˆ¶ç®¡ç†å·¥å…· - Orchestrator  | John Wong&#39;s Blog</title>
  <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="https://jwangkun.github.io/media/css/bootstrap.min.css" rel="stylesheet"> -->
  <!--  <link href="https://jwangkun.github.io/media/css/all.min.css" rel="stylesheet" type="text/css"> -->
  <link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  <link rel="alternate" type="application/rss+xml" title="MySQL é«˜å¯ç”¨å¤åˆ¶ç®¡ç†å·¥å…· - Orchestrator  | John Wong&#39;s Blog Â» Feed" href="https://jwangkun.github.io/atom.xml">
  <link rel="stylesheet"href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
  <link href="https://jwangkun.github.io/styles/main.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/highlight.min.js"></script>
  <!-- <script src="https://jwangkun.github.io/media/scripts/jquery.min.js"></script> -->
  <script>hljs.initHighlightingOnLoad();</script>
  

    <meta property="og:description" content="MySQL é«˜å¯ç”¨å¤åˆ¶ç®¡ç†å·¥å…· - Orchestrator "/>
    <meta property="og:url" content="https://jwangkun.github.io/3KLBeooeF/"/>
    <meta property="og:locale" content="zh-CN"/>
    <meta property="og:type" content="website"/>
    <meta property="og:site_name" content="John Wong&#39;s Blog"/>
  </head>
  <body>
  	<!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https://jwangkun.github.io">John Wong&#39;s Blog</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          
          <li class="nav-item">
              
              <a class="nav-link" href="/">é¦–é¡µ</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/archives">å½’æ¡£</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/tags">æ ‡ç­¾</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/about">å…³äº</a>
              
          </li>
          
        </ul>
      </div>
    </div>
  </nav>
  <!-- Page Header -->
  <header class="masthead" style="background-image: url('https://jwangkun.github.io/media/images/home-bg.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
          	<span class="tags">
          	 
            <a href="https://jwangkun.github.io/_JVrn2ZGG/" class="tag">MySQL</a>
            
            <a href="https://jwangkun.github.io/6at1zEuw1/" class="tag">Orchestrator</a>
            
        </span>
            <h1>MySQL é«˜å¯ç”¨å¤åˆ¶ç®¡ç†å·¥å…· - Orchestrator </h1>
            <span class="meta">
            	Posted on
              2020-11-18ï¼Œ44 min read
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <h2 id="æµ‹è¯•è¯´æ˜">æµ‹è¯•è¯´æ˜</h2>
<h3 id="ç¯å¢ƒä»‹ç»">ç¯å¢ƒä»‹ç»</h3>
<p>æœåŠ¡å™¨ç¯å¢ƒï¼š</p>
<pre><code>ä¸‰å°æœåŠ¡å™¨
1ï¼šMySQLå®ä¾‹ï¼ˆ3306æ˜¯orchçš„åç«¯æ•°æ®åº“ï¼Œ3307æ˜¯MySQLä¸»ä»æ¶æ„ã€Œå¼€å¯GTIDã€ï¼‰
Master ï¼š192.168.163.131:3307
Slave  ï¼š192.168.163.132:3307
Slave  ï¼š192.168.163.133:3307

2ï¼šhostsï¼ˆetc/hostsï¼‰ï¼š
192.168.163.131 test1
192.168.163.132 test2
192.168.163.133 test3
</code></pre>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œorch æ£€æµ‹ä¸»åº“å®•æœºä¾èµ–ä»åº“çš„ IO çº¿ç¨‹ï¼ˆæœ¬èº«è¿ä¸ä¸Šä¸»åº“åï¼Œè¿˜ä¼šé€šè¿‡ä»åº“å†å»æ£€æµ‹ä¸»åº“æ˜¯å¦å¼‚å¸¸ï¼‰ï¼Œæ‰€ä»¥é»˜è®¤ change æ­å»ºçš„ä¸»ä»æ„ŸçŸ¥ä¸»åº“å®•æœºçš„ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œéœ€è¦éœ€è¦ç¨å¾®æ”¹ä¸‹ï¼š</p>
<pre><code>change master to master_host='192.168.163.131',master_port=3307,master_user='rep',master_password='rep',master_auto_position=1,MASTER_HEARTBEAT_PERIOD=2,MASTER_CONNECT_RETRY=1, MASTER_RETRY_COUNT=86400;
</code></pre>
<pre><code>set global slave_net_timeout=8;
</code></pre>
<pre><code>slave_net_timeoutï¼ˆå…¨å±€å˜é‡ï¼‰ï¼šMySQL5.7.7ä¹‹åï¼Œé»˜è®¤æ”¹æˆ60ç§’ã€‚è¯¥å‚æ•°å®šä¹‰äº†ä»åº“ä»ä¸»åº“è·å–æ•°æ®ç­‰å¾…çš„ç§’æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ä»åº“ä¼šä¸»åŠ¨é€€å‡ºè¯»å–ï¼Œä¸­æ–­è¿æ¥ï¼Œå¹¶å°è¯•é‡è¿ã€‚
</code></pre>
<p><a href="http://dev.mysql.com/doc/refman/5.7/en/change-master-to.html">master_heartbeat_period</a>ï¼šå¤åˆ¶å¿ƒè·³çš„å‘¨æœŸã€‚é»˜è®¤æ˜¯ <a href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-slave.html#sysvar_slave_net_timeout">slave_net_timeout</a> çš„ä¸€åŠã€‚Master åœ¨æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œæ¯ <a href="http://dev.mysql.com/doc/refman/5.7/en/change-master-to.html">master_heartbeat_period</a> ç§’å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…ï¼Œè¿™æ · Slave å°±èƒ½çŸ¥é“ Master æ˜¯ä¸æ˜¯è¿˜æ­£å¸¸ã€‚</p>
<p>slave_net_timeout æ˜¯è®¾ç½®åœ¨å¤šä¹…æ²¡æ”¶åˆ°æ•°æ®åè®¤ä¸ºç½‘ç»œè¶…æ—¶ï¼Œä¹‹å Slave çš„ IO çº¿ç¨‹ä¼šé‡æ–°è¿æ¥ Master ã€‚ç»“åˆè¿™ä¸¤ä¸ªè®¾ç½®å°±å¯ä»¥é¿å…ç”±äºç½‘ç»œé—®é¢˜å¯¼è‡´çš„å¤åˆ¶å»¶è¯¯ã€‚master_heartbeat_period å•ä½æ˜¯ç§’ï¼Œå¯ä»¥æ˜¯ä¸ªå¸¦ä¸Šå°æ•°ï¼Œå¦‚ 10.5ï¼Œæœ€é«˜ç²¾åº¦ä¸º 1 æ¯«ç§’ã€‚</p>
<pre><code>é‡è¯•ç­–ç•¥ä¸ºï¼š
å¤‡åº“è¿‡äº†slave-net-timeoutç§’è¿˜æ²¡æœ‰æ”¶åˆ°ä¸»åº“æ¥çš„æ•°æ®ï¼Œå®ƒå°±ä¼šå¼€å§‹ç¬¬ä¸€æ¬¡é‡è¯•ã€‚ç„¶åæ¯è¿‡ master-connect-retry ç§’ï¼Œå¤‡åº“ä¼šå†æ¬¡å°è¯•é‡è¿ä¸»åº“ã€‚ç›´åˆ°é‡è¯•äº† master-retry-count æ¬¡ï¼Œå®ƒæ‰ä¼šæ”¾å¼ƒé‡è¯•ã€‚å¦‚æœé‡è¯•çš„è¿‡ç¨‹ä¸­ï¼Œè¿ä¸Šäº†ä¸»åº“ï¼Œé‚£ä¹ˆå®ƒè®¤ä¸ºå½“å‰ä¸»åº“æ˜¯å¥½çš„ï¼Œåˆä¼šå¼€å§‹ slave-net-timeout ç§’çš„ç­‰å¾…ã€‚
slave-net-timeout çš„é»˜è®¤å€¼æ˜¯ 60 ç§’ï¼Œ master-connect-retry é»˜è®¤ä¸º 60 ç§’ï¼Œ master-retry-count é»˜è®¤ä¸º 86400 æ¬¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸»åº“ä¸€åˆ†é’Ÿéƒ½æ²¡æœ‰ä»»ä½•æ•°æ®å˜æ›´å‘é€è¿‡æ¥ï¼Œå¤‡åº“æ‰ä¼šå°è¯•é‡è¿ä¸»åº“ã€‚
</code></pre>
<p>è¿™æ ·ï¼Œä¸»åº“å®•æœºä¹‹åï¼Œçº¦ 8~10 ç§’æ„ŸçŸ¥ä¸»åº“å¼‚å¸¸ï¼Œ<a href="https://github.com/github/orchestrator">Orchestrator</a> å¼€å§‹åˆ‡æ¢ã€‚å¦å¤–è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œorch é»˜è®¤æ˜¯ç”¨ä¸»æœºåæ¥è¿›è¡Œç®¡ç†çš„ï¼Œéœ€è¦åœ¨ mysql çš„é…ç½®æ–‡ä»¶é‡Œæ·»åŠ ï¼šreport_host å’Œ report_port å‚æ•°ã€‚</p>
<p>æ•°æ®åº“ç¯å¢ƒï¼š</p>
<pre><code>Orchestratoråç«¯æ•°æ®åº“ï¼š
åœ¨å¯åŠ¨Orchestratorç¨‹åºçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åœ¨æ•°æ®åº“é‡Œåˆ›å»ºorchestratoræ•°æ®åº“ï¼Œä¿å­˜orchestratorçš„ä¸€äº›æ•°æ®ä¿¡æ¯ã€‚

Orchestratorç®¡ç†çš„æ•°æ®åº“ï¼š
åœ¨é…ç½®æ–‡ä»¶é‡Œé…ç½®çš„ä¸€äº›queryå‚æ•°ï¼Œéœ€è¦åœ¨æ¯ä¸ªè¢«ç®¡ç†çš„ç›®æ ‡åº“é‡Œæœ‰metaåº“æ¥ä¿ç•™ä¸€äº›å…ƒä¿¡æ¯ï¼ˆç±»ä¼¼cmdbåŠŸèƒ½ï¼‰ï¼Œæ¯”å¦‚ç”¨pt-heartbeatæ¥éªŒè¯ä¸»ä»å»¶è¿Ÿï¼›ç”¨clusterè¡¨æ¥ä¿å­˜åˆ«åã€æ•°æ®ä¸­å¿ƒç­‰ã€‚
</code></pre>
<p>å¦‚ä¸‹é¢æ˜¯æµ‹è¯•ç¯å¢ƒçš„ cluster è¡¨ä¿¡æ¯ï¼š</p>
<pre><code>&gt; CREATE TABLE `cluster` (
  `anchor` tinyint(4) NOT NULL,
  `cluster_name` varchar(128) CHARACTER SET ascii NOT NULL DEFAULT '',
  `cluster_domain` varchar(128) CHARACTER SET ascii NOT NULL DEFAULT '',
  `data_center` varchar(128) NOT NULL,
  PRIMARY KEY (`anchor`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8

&gt;select * from cluster;
+--------+--------------+----------------+-------------+
| anchor | cluster_name | cluster_domain | data_center |
+--------+--------------+----------------+-------------+
|      1 | test         | CaoCao         | BJ          |
+--------+--------------+----------------+-------------+
</code></pre>
<h3 id="æµ‹è¯•è¯´æ˜-2">æµ‹è¯•è¯´æ˜</h3>
<p>å¼€å¯ <a href="https://github.com/github/orchestrator">Orchestrator</a> è¿›ç¨‹ï¼š</p>
<pre><code>./orchestrator --config=/etc/orchestrator.conf.json http
</code></pre>
<p>åœ¨æµè§ˆå™¨é‡Œè¾“å…¥ä¸‰å°ä¸»æœºçš„ä»»æ„ä¸»æœºçš„ IP åŠ ç«¯å£ï¼ˆhttp://192.168.163.131:3000ï¼‰è¿›å…¥åˆ° Web ç®¡ç†ç•Œé¢ï¼Œåœ¨ Clusters å¯¼èˆªçš„ Discover é‡Œè¾“å…¥ä»»æ„ä¸€å°è¢«ç®¡ç† MySQL å®ä¾‹çš„ä¿¡æ¯ã€‚æ·»åŠ å®Œæˆä¹‹åï¼ŒWeb ç•Œé¢æ•ˆæœï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190218170011479-429145698.png" alt="img" loading="lazy"></figure>
<p>åœ¨ web ä¸Šå¯ä»¥è¿›è¡Œç›¸å…³çš„ç®¡ç†ï¼Œå…³äº Web ä¸Šçš„ç›¸å…³æŒ‰é’®çš„è¯´æ˜ï¼Œä¸‹é¢ä¼šåšç›¸å…³è¯´æ˜ï¼š</p>
<p><strong>1.</strong> <strong>éƒ¨åˆ†å¯ä¿®æ”¹çš„å‚æ•°</strong> (ç‚¹å‡» Web ä¸Šéœ€è¦è¢«ä¿®æ”¹å®ä¾‹çš„ä»»æ„å›¾æ ‡ï¼‰ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219010132613-2042001429.png" alt="img" loading="lazy"></figure>
<p>è¯´æ˜</p>
<pre><code>Instance Alias ï¼šå®ä¾‹åˆ«å
Last seen       :  æœ€åæ£€æµ‹æ—¶é—´
Self coordinates ï¼šè‡ªèº«çš„binlogä½ç‚¹ä¿¡æ¯
Num replicas ï¼šæœ‰å‡ ä¸ªä»åº“
Server ID    ï¼š MySQL server_id
Server UUID ï¼š    MySQL UUID
Version ï¼š    ç‰ˆæœ¬
Read only ï¼š æ˜¯å¦åªè¯»
Has binary logs ï¼šæ˜¯å¦å¼€å¯binlog
Binlog format    ï¼šbinlog æ¨¡å¼
Logs slave updates ï¼šæ˜¯å¦å¼€å¯log_slave_updates
GTID supported ï¼šæ˜¯å¦æ”¯æŒGTID
GTID based replication ï¼šæ˜¯å¦æ˜¯åŸºäºGTIDçš„å¤åˆ¶
GTID mode    ï¼šå¤åˆ¶æ˜¯å¦å¼€å¯äº†GTID
Executed GTID set ï¼šå¤åˆ¶ä¸­æ‰§è¡Œè¿‡çš„GTIDåˆ—è¡¨
Uptime ï¼šå¯åŠ¨æ—¶é—´
Allow TLS ï¼šæ˜¯å¦å¼€å¯TLS
Cluster ï¼šé›†ç¾¤åˆ«å
Audit ï¼šå®¡è®¡å®ä¾‹
Agent ï¼šAgentå®ä¾‹
</code></pre>
<p>è¯´æ˜ï¼šä¸Šé¢å›¾ä¸­ï¼Œåé¢æœ‰æŒ‰é’®çš„éƒ½æ˜¯å¯ä»¥åœ¨ Web ä¸Šè¿›è¡Œä¿®æ”¹çš„åŠŸèƒ½ï¼Œå¦‚ï¼šæ˜¯å¦åªè¯»ï¼Œæ˜¯å¦å¼€å¯ GTID çš„å¤åˆ¶ç­‰ã€‚å…¶ä¸­ Begin Downtime ä¼šå°†å®ä¾‹æ ‡è®°ä¸ºå·²åœç”¨ï¼Œæ­¤æ—¶å¦‚æœå‘ç”Ÿ Failoverï¼Œè¯¥å®ä¾‹ä¸ä¼šå‚ä¸ã€‚</p>
<p><strong>2. ä»»æ„æ”¹å˜ä¸»ä»çš„æ‹“æ‰‘ç»“æ„</strong>ï¼šå¯ä»¥ç›´æ¥åœ¨å›¾ä¸Šæ‹–åŠ¨å˜æ›´å¤åˆ¶ï¼Œä¼šè‡ªåŠ¨æ¢å¤æ‹“æ‰‘å…³ç³»ï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190218170338591-1722669532.gif" alt="img" loading="lazy"></figure>
<p><strong>3. ä¸»åº“æŒ‚äº†ä¹‹åè‡ªåŠ¨ Failover</strong>ï¼Œå¦‚ï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190218172337242-1994050306.gif" alt="img" loading="lazy"></figure>
<p>å›¾ä¸­æ˜¾ç¤ºï¼Œå½“ä¸»æŒ‚æ‰ä¹‹åï¼Œæ‹“æ‰‘ç»“æ„é‡Œè‡ªåŠ¨å‰”é™¤è¯¥ä¸»èŠ‚ç‚¹ï¼Œé€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„ä»åº“æå‡æˆä¸»åº“ï¼Œå¹¶ä¿®å¤å¤åˆ¶æ‹“æ‰‘ã€‚åœ¨ Failover è¿‡ç¨‹å½“ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹ / tmp/recovery.log æ–‡ä»¶ï¼ˆé…ç½®æ–‡ä»¶é‡Œå®šæ­»ï¼‰ï¼Œé‡Œé¢åŒ…å«äº†åœ¨ Failover è¿‡ç¨‹ä¸­ Hooks æ‰§è¡Œçš„å¤–éƒ¨è„šæœ¬ï¼Œç±»ä¼¼ MHA çš„ master_ip_failover_script å‚æ•°ã€‚å¯ä»¥é€šè¿‡å¤–éƒ¨è„šæœ¬è¿›è¡Œç›¸åº”çš„å¦‚ï¼šVIP åˆ‡æ¢ã€Proxy ä¿®æ”¹ã€DNS ä¿®æ”¹ã€ä¸­é—´ä»¶ä¿®æ”¹ã€LVS ä¿®æ”¹ç­‰ç­‰ï¼Œå…·ä½“çš„æ‰§è¡Œè„šæœ¬å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µç¼–å†™ã€‚</p>
<p><strong>4. <a href="https://github.com/github/orchestrator">Orchestrator</a> <a href="https://github.com/github/orchestrator/blob/master/docs/raft-vs-sync-repl.md">é«˜å¯ç”¨</a></strong>ã€‚å› ä¸ºåœ¨ä¸€å¼€å§‹å°±å·²ç»éƒ¨ç½²äº† 3 å°ï¼Œé€šè¿‡<a href="https://github.com/github/orchestrator/blob/master/docs/configuration-raft.md">é…ç½®æ–‡ä»¶</a>é‡Œçš„ <a href="https://github.com/github/orchestrator/blob/master/docs/deployment-raft.md">Raft</a> å‚æ•°è¿›è¡Œé€šä¿¡ã€‚åªè¦æœ‰ 2 ä¸ªèŠ‚ç‚¹çš„ <a href="https://github.com/github/orchestrator">Orchestrator</a> æ­£å¸¸ï¼Œå°±ä¸ä¼šå½±å“ä½¿ç”¨ï¼Œå¦‚æœå‡ºç° 2 ä¸ªèŠ‚ç‚¹çš„ <a href="https://github.com/github/orchestrator">Orchestrator</a> å¼‚å¸¸ï¼Œåˆ™ Failover ä¼šå¤±è´¥ã€‚2 ä¸ªèŠ‚ç‚¹å¼‚å¸¸çš„å›¾å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190218180148778-225961613.png" alt="img" loading="lazy"></figure>
<p>å›¾ä¸­çš„å„ä¸ªèŠ‚ç‚¹å…¨éƒ¨æ˜¾ç¤ºç°è‰²ï¼Œæ­¤æ—¶ Raft ç®—æ³•å¤±æ•ˆï¼Œå¯¼è‡´ Orch çš„ Failover åŠŸèƒ½å¤±è´¥ã€‚ç›¸å¯¹æ¯” MHA çš„ Manager çš„å•ç‚¹ï¼Œ<a href="https://github.com/github/orchestrator">Orchestrator</a> é€šè¿‡ Raft ç®—æ³•è§£å†³äº†æœ¬èº«çš„é«˜å¯ç”¨æ€§ä»¥åŠè§£å†³ç½‘ç»œéš”ç¦»é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯è·¨æ•°æ®ä¸­å¿ƒç½‘ç»œå¼‚å¸¸ã€‚è¿™é‡Œè¯´æ˜ä¸‹ Raftï¼Œé€šè¿‡å…±è¯†ç®—æ³•ï¼š</p>
<p><a href="https://github.com/github/orchestrator">Orchestrator</a> èŠ‚ç‚¹èƒ½å¤Ÿé€‰æ‹©å…·æœ‰ä»²è£çš„é¢†å¯¼è€…ï¼ˆleaderï¼‰ã€‚å¦‚æœ‰ 3 ä¸ª orch èŠ‚ç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªå¯ä»¥æˆä¸º leaderï¼ˆ3 èŠ‚ç‚¹ä»²è£å¤§å°ä¸º 2ï¼Œ5 èŠ‚ç‚¹ä»²è£å¤§å°ä¸º 3ï¼‰ã€‚åªå…è®¸ leader è¿›è¡Œä¿®æ”¹ï¼Œæ¯ä¸ª MySQL æ‹“æ‰‘æœåŠ¡å™¨å°†ç”±ä¸‰ä¸ªä¸åŒçš„ orchestrator èŠ‚ç‚¹ç‹¬ç«‹è®¿é—®ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸‰ä¸ªèŠ‚ç‚¹å°†çœ‹åˆ°æˆ–å¤šæˆ–å°‘ç›¸åŒçš„æ‹“æ‰‘å›¾ï¼Œä½†ä»–ä»¬æ¯ä¸ªéƒ½ä¼šç‹¬ç«‹åˆ†æå†™å…¥å…¶è‡ªå·±çš„ä¸“ç”¨åç«¯æ•°æ®åº“æœåŠ¡å™¨ï¼š</p>
<p>â‘  æ‰€æœ‰æ›´æ”¹éƒ½å¿…é¡»é€šè¿‡ leaderã€‚</p>
<p>â‘¡ åœ¨å¯ç”¨ raft æ¨¡å¼ä¸Šç¦æ­¢ä½¿ç”¨ orchestrator å®¢æˆ·ç«¯ã€‚</p>
<p>â‘¢ åœ¨å¯ç”¨ raft æ¨¡å¼ä¸Šä½¿ç”¨ orchestrator-clientï¼Œorchestrator-client å¯ä»¥å®‰è£…åœ¨æ²¡æœ‰ orchestrator ä¸Šçš„æœåŠ¡å™¨ã€‚</p>
<p>â‘£ å•ä¸ª orchestrator èŠ‚ç‚¹çš„æ•…éšœä¸ä¼šå½±å“ orchestrator çš„å¯ç”¨æ€§ã€‚åœ¨ 3 èŠ‚ç‚¹è®¾ç½®ä¸Šï¼Œæœ€å¤šä¸€ä¸ªæœåŠ¡å™¨å¯èƒ½ä¼šå¤±è´¥ã€‚åœ¨ 5 èŠ‚ç‚¹è®¾ç½®ä¸Šï¼Œ2 ä¸ªèŠ‚ç‚¹å¯èƒ½ä¼šå¤±è´¥ã€‚</p>
<p>â‘¤ Orchestrator èŠ‚ç‚¹å¼‚å¸¸å…³é—­ï¼Œç„¶åå†å¯åŠ¨ã€‚å®ƒå°†é‡æ–°åŠ å…¥ Raft ç»„ï¼Œå¹¶æ¥æ”¶é—æ¼çš„ä»»ä½•äº‹ä»¶, åªè¦æœ‰è¶³å¤Ÿçš„ Raft è®°å½•ã€‚</p>
<p>â‘¥ è¦åŠ å…¥æ¯”æ—¥å¿—ä¿ç•™å…è®¸çš„æ›´é•¿ / æ›´è¿œçš„ orchestrator èŠ‚ç‚¹æˆ–è€…æ•°æ®åº“å®Œå…¨ä¸ºç©ºçš„èŠ‚ç‚¹ï¼Œéœ€è¦ä»å¦ä¸€ä¸ªæ´»åŠ¨èŠ‚ç‚¹<a href="https://github.com/github/orchestrator/blob/master/docs/raft.md#behavior-and-implications-of-orchestratorraft-setup">å…‹éš†åç«¯ DB</a>ã€‚</p>
<p>å…³äº Raft æ›´å¤šçš„ä¿¡æ¯è§ï¼šhttps://github.com/github/orchestrator/blob/master/docs/raft.md</p>
<p><a href="https://github.com/github/orchestrator">Orchestrator</a> çš„<a href="https://github.com/github/orchestrator/blob/master/docs/raft-vs-sync-repl.md"><strong>é«˜å¯ç”¨æœ‰ 2 ç§æ–¹å¼</strong></a>ï¼Œç¬¬ä¸€ç§å°±æ˜¯ä¸Šé¢è¯´çš„é€šè¿‡ <a href="https://github.com/github/orchestrator/blob/master/docs/deployment-raft.md">Raft</a>ï¼ˆæ¨èï¼‰ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡<a href="https://github.com/github/orchestrator/blob/master/docs/deployment-shared-backend.md">åç«¯æ•°æ®åº“çš„åŒæ­¥</a>ã€‚è¯¦ç»†ä¿¡æ¯è§<a href="https://github.com/github/orchestrator/blob/master/docs/raft-vs-sync-repl.md">æ–‡æ¡£</a>ã€‚æ–‡æ¡£é‡Œè¯¦ç»†æ¯”è¾ƒäº†ä¸¤ç§é«˜å¯ç”¨æ€§éƒ¨ç½²æ–¹æ³•ã€‚ä¸¤ç§æ–¹æ³•çš„å›¾å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="6"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219225803246-157307488.png" alt="img" loading="lazy"></figure>
<p>åˆ°è¿™é‡Œï¼Œ<a href="https://github.com/github/orchestrator">Orchestrator</a> çš„åŸºæœ¬åŠŸèƒ½å·²ç»å®ç°ï¼ŒåŒ…æ‹¬ä¸»åŠ¨ Failoverã€ä¿®æ”¹æ‹“æ‰‘ç»“æ„ä»¥åŠ Web ä¸Šçš„å¯è§†åŒ–æ“ä½œã€‚</p>
<p><strong>5. Web ä¸Šå„ä¸ªæŒ‰é’®çš„åŠŸèƒ½è¯´æ˜</strong></p>
<p>â‘ ï¼šHome ä¸‹çš„ statusï¼šæŸ¥çœ‹ orch çš„çŠ¶æ€ï¼šåŒ…æ‹¬è¿è¡Œæ—¶é—´ã€ç‰ˆæœ¬ã€åç«¯æ•°æ®åº“ä»¥åŠå„ä¸ª Raft èŠ‚ç‚¹çš„çŠ¶æ€ã€‚</p>
<p>â‘¡ï¼šCluster ä¸‹çš„ dashboardï¼šæŸ¥çœ‹ orch ä¸‹çš„æ‰€æœ‰è¢«ç®¡ç†çš„ MySQL å®ä¾‹ã€‚</p>
<p>â‘¢ï¼šCluster ä¸‹çš„ Failure analysisï¼šæŸ¥çœ‹æ•…éšœåˆ†æä»¥åŠåŒ…æ‹¬è®°å½•çš„æ•…éšœç±»å‹åˆ—è¡¨ã€‚</p>
<p>â‘£ï¼šCluster ä¸‹çš„ Discoverï¼šç”¨æ¥å‘ç°è¢«ç®¡ç†çš„ MySQL å®ä¾‹ã€‚</p>
<p>â‘¤ï¼šAudit ä¸‹çš„ Failure detectionï¼šæ•…éšœæ£€æµ‹ä¿¡æ¯ï¼ŒåŒ…å«å†å²ä¿¡æ¯ã€‚</p>
<p>â‘¥ï¼šAudit ä¸‹çš„ Recoveryï¼šæ•…éšœæ¢å¤ä¿¡æ¯ä»¥åŠæ•…éšœç¡®è®¤ã€‚</p>
<p>â‘¦ï¼šAudit ä¸‹çš„ <a href="https://github.com/github/orchestrator-agent">Agent</a>ï¼šæ˜¯ä¸€ä¸ªåœ¨ MySQL ä¸»æœºä¸Šè¿è¡Œå¹¶ä¸ orchestrator é€šä¿¡çš„æœåŠ¡ï¼Œèƒ½å¤Ÿå‘ orch æä¾›æ“ä½œç³»ç»Ÿï¼Œæ–‡ä»¶ç³»ç»Ÿå’Œ LVM ä¿¡æ¯ï¼Œä»¥åŠè°ƒç”¨æŸäº›å‘½ä»¤å’Œè„šæœ¬ã€‚</p>
<p>â‘§ï¼šå¯¼èˆªæ é‡Œçš„</p>
<p>å›¾æ ‡ï¼Œå¯¹åº”å·¦è¾¹å¯¼èˆªæ çš„å›¾æ ‡ï¼š</p>
<p>ç¬¬ 1 è¡Œï¼šé›†ç¾¤åˆ«åçš„æŸ¥çœ‹ä¿®æ”¹ã€‚</p>
<p>ç¬¬ 2 è¡Œï¼špoolsã€‚</p>
<p>ç¬¬ 3 è¡Œï¼šCompact displayï¼Œç´§å‡‘å±•ç¤ºã€‚</p>
<p>![img](https://img2018.cnblogs.com/blog/163084/201902/163084-20190219115128134-967922582.png</p>
<p>ç¬¬ 4 è¡Œï¼šPool indicatorï¼Œæ± æŒ‡ç¤ºå™¨ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219115400308-424272566.png" alt="img" loading="lazy"></figure>
<p>ç¬¬ 5 è¡Œï¼šColorize DCï¼Œæ¯ä¸ªæ•°æ®ä¸­å¿ƒç”¨ä¸åŒé¢œè‰²å±•ç¤ºã€‚</p>
<figure data-type="image" tabindex="8"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219115630089-1429833411.png" alt="img" loading="lazy"></figure>
<p>ç¬¬ 6 è¡Œï¼šAnonymizeï¼ŒåŒ¿åé›†ç¾¤ä¸­çš„ä¸»æœºåã€‚</p>
<figure data-type="image" tabindex="9"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219115942562-1845343072.png" alt="img" loading="lazy"></figure>
<p>æ³¨æ„ï¼šå·¦è¾¹å¯¼èˆªæ é‡Œçš„</p>
<figure data-type="image" tabindex="10"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219120053779-131236462.png" alt="img" loading="lazy"></figure>
<p>å›¾æ ‡ï¼Œè¡¨ç¤ºå®ä¾‹çš„æ¦‚æ‹¬ï¼šå®ä¾‹åã€åˆ«åã€æ•…éšœæ£€æµ‹å’Œæ¢å¤ç­‰ä¿¡æ¯ã€‚</p>
<p>â‘§ï¼šå¯¼èˆªæ é‡Œçš„</p>
<figure data-type="image" tabindex="11"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219120323532-1505321279.png" alt="img" loading="lazy"></figure>
<p>å›¾æ ‡ï¼Œè¡¨ç¤ºæ˜¯å¦ç¦æ­¢å…¨å±€æ¢å¤ã€‚ç¦æ­¢æ‰çš„è¯ä¸ä¼šè¿›è¡Œ Failoverã€‚</p>
<p>â‘¨ï¼šå¯¼èˆªæ é‡Œçš„</p>
<figure data-type="image" tabindex="12"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219133056778-1995235495.png" alt="img" loading="lazy"></figure>
<p>å›¾æ ‡ï¼Œè¡¨ç¤ºæ˜¯å¦å¼€å¯åˆ·æ–°é¡µé¢ï¼ˆé»˜è®¤ 60 ä¸€æ¬¡ï¼‰ã€‚</p>
<p>â‘©ï¼šå¯¼èˆªæ é‡Œçš„</p>
<figure data-type="image" tabindex="13"><img src="https://img2018.cnblogs.com/blog/163084/201902/163084-20190219134020045-306472431.png" alt="img" loading="lazy"></figure>
<p>å›¾æ ‡ï¼Œè¡¨ç¤º MySQL å®ä¾‹è¿ç§»æ¨¡å¼ã€‚</p>
<pre><code>Smart modeï¼šè‡ªåŠ¨é€‰æ‹©è¿ç§»æ¨¡å¼ï¼Œè®©Orchè‡ªå·±é€‰æ‹©è¿ç§»æ¨¡å¼ã€‚
Classic modeï¼šç»å…¸è¿ç§»æ¨¡å¼ï¼Œé€šè¿‡binlogå’Œpositionè¿›è¡Œè¿ç§»ã€‚
GTID modeï¼šGTIDè¿ç§»æ¨¡å¼ã€‚
Pseudo GTID modeï¼šä¼ªGTIDè¿ç§»æ¨¡å¼ã€‚
</code></pre>
<p>åˆ°æ­¤ï¼Œ<a href="https://github.com/github/orchestrator">Orchestrator</a> çš„åŸºæœ¬æµ‹è¯•å’Œ Web è¯´æ˜å·²ç»ä»‹ç»å®Œæ¯•ã€‚å’Œ MHA æ¯”å·²ç»æœ‰å¾ˆå¤§çš„ä½“éªŒæå‡ï¼Œä¸ä»…åœ¨ Web è¿›è¡Œéƒ¨åˆ†å‚æ•°çš„è®¾ç½®ä¿®æ”¹ï¼Œè¿˜å¯ä»¥æ”¹å˜å¤åˆ¶æ‹“æ‰‘ï¼Œæœ€é‡è¦çš„æ˜¯è§£å†³ MHA Manager å•ç‚¹çš„é—®é¢˜ã€‚è¿˜æœ‰ä»€ä¹ˆç†ç”±ä¸æ›¿æ¢ MHA å‘¢ï¼ŸğŸ˜ƒ</p>
<h2 id="å·¥ä½œæµç¨‹è¯´æ˜">å·¥ä½œæµç¨‹è¯´æ˜</h2>
<p><a href="https://github.com/github/orchestrator">Orchestrator</a> å®ç°äº†è‡ªåŠ¨ Failoverï¼Œç°åœ¨æ¥çœ‹çœ‹è‡ªåŠ¨ Failover çš„å¤§è‡´æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p>
<p><strong>1.</strong> <a href="https://github.com/github/orchestrator/blob/master/docs/failure-detection.md"><strong>æ£€æµ‹æµç¨‹</strong></a></p>
<p>â‘  orchestrator åˆ©ç”¨å¤åˆ¶æ‹“æ‰‘ï¼Œå…ˆæ£€æŸ¥ä¸»æœ¬èº«ï¼Œå¹¶è§‚å¯Ÿå…¶ slavesã€‚</p>
<p>â‘¡ å¦‚æœ orchestrator æœ¬èº«è¿ä¸ä¸Šä¸»ï¼Œå¯ä»¥è¿ä¸Šè¯¥ä¸»çš„ä»ï¼Œåˆ™é€šè¿‡ä»å»æ£€æµ‹ï¼Œè‹¥åœ¨ä»ä¸Šä¹Ÿçœ‹ä¸åˆ°ä¸»ï¼ˆIO Threadï¼‰ã€Œ2 æ¬¡æ£€æŸ¥ã€ï¼Œåˆ¤æ–­ Master å®•æœºã€‚</p>
<p>è¯¥æ£€æµ‹æ–¹æ³•æ¯”è¾ƒåˆç†ï¼Œå½“ä»éƒ½è¿ä¸ä¸Šä¸»äº†ï¼Œåˆ™å¤åˆ¶è‚¯å®šæœ‰å‡ºé—®é¢˜ï¼Œæ•…ä¼šè¿›è¡Œåˆ‡æ¢ã€‚æ‰€ä»¥åœ¨ç”Ÿäº§ä¸­éå¸¸å¯é ã€‚</p>
<p>æ£€æµ‹å‘ç”Ÿæ•…éšœåå¹¶ä¸éƒ½ä¼šè¿›è¡Œè‡ªåŠ¨æ¢å¤ï¼Œæ¯”å¦‚ï¼šç¦æ­¢å…¨å±€æ¢å¤ã€è®¾ç½®äº† shutdown timeã€ä¸Šæ¬¡æ¢å¤ç¦»æœ¬æ¬¡æ¢å¤æ—¶é—´åœ¨ RecoveryPeriodBlockSeconds è®¾ç½®çš„æ—¶é—´å†…ã€å¤±è´¥ç±»å‹ä¸è¢«è®¤ä¸ºå€¼å¾—æ¢å¤ç­‰ã€‚æ£€æµ‹ä¸æ¢å¤æ— å…³ï¼Œä½†å§‹ç»ˆå¯ç”¨ã€‚ æ¯æ¬¡æ£€æµ‹éƒ½ä¼šæ‰§è¡Œ OnFailureDetectionProcesses Hooksã€‚</p>
<p><a href="https://github.com/github/orchestrator/blob/master/docs/configuration-failure-detection.md">é…ç½®æ•…éšœæ£€æµ‹</a>ï¼š</p>
<pre><code>{
  &quot;FailureDetectionPeriodBlockMinutes&quot;: 60,
}

Hooksç›¸å…³å‚æ•°ï¼š
{
  &quot;OnFailureDetectionProcesses&quot;: [
    &quot;echo 'Detected {failureType} on {failureCluster}. Affected replicas: {countReplicas}' &gt;&gt; /tmp/recovery.log&quot;
  ],
}

MySQLå¤åˆ¶ç›¸å…³è°ƒæ•´ï¼š
slave_net_timeout
MASTER_CONNECT_RETRY
</code></pre>
<p><strong>2. <a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md">æ¢å¤æµç¨‹</a></strong></p>
<p>æ¢å¤çš„å®ä¾‹éœ€è¦æ”¯æŒï¼šGTIDã€ä¼ª GTIDã€å¼€å¯ Binlogã€‚<a href="https://github.com/github/orchestrator/blob/master/docs/configuration-recovery.md">æ¢å¤çš„é…ç½®</a>å¦‚ä¸‹ï¼š</p>
<pre><code>{
  &quot;RecoveryPeriodBlockSeconds&quot;: 3600,
  &quot;RecoveryIgnoreHostnameFilters&quot;: [],
  &quot;RecoverMasterClusterFilters&quot;: [
    &quot;thiscluster&quot;,
    &quot;thatcluster&quot;
  ],
  &quot;RecoverMasterClusterFilters&quot;: [&quot;*&quot;],
  &quot;RecoverIntermediateMasterClusterFilters&quot;: [
    &quot;*&quot;
  ],
}

{
  &quot;ApplyMySQLPromotionAfterMasterFailover&quot;: true,
  &quot;PreventCrossDataCenterMasterFailover&quot;: false,
  &quot;FailMasterPromotionIfSQLThreadNotUpToDate&quot;: true,
  &quot;MasterFailoverLostInstancesDowntimeMinutes&quot;: 10,
  &quot;DetachLostReplicasAfterMasterFailover&quot;: true,
}

Hooksï¼š
{
  &quot;PreGracefulTakeoverProcesses&quot;: [
    &quot;echo 'Planned takeover about to take place on {failureCluster}. Master will switch to read_only' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PreFailoverProcesses&quot;: [
    &quot;echo 'Will recover from {failureType} on {failureCluster}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PostFailoverProcesses&quot;: [
    &quot;echo '(for all types) Recovered from {failureType} on {failureCluster}. Failed: {failedHost}:{failedPort}; Successor: {successorHost}:{successorPort}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PostUnsuccessfulFailoverProcesses&quot;: [],
  &quot;PostMasterFailoverProcesses&quot;: [
    &quot;echo 'Recovered from {failureType} on {failureCluster}. Failed: {failedHost}:â€¨    {failedPort}; Promoted: {successorHost}:{successorPort}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PostIntermediateMasterFailoverProcesses&quot;: [],
  &quot;PostGracefulTakeoverProcesses&quot;: [
    &quot;echo 'Planned takeover complete' &gt;&gt; /tmp/recovery.log&quot;
  ],
}
</code></pre>
<p>å…·ä½“çš„å‚æ•°å«ä¹‰è¯·å‚è€ƒã€Œ<a href="https://www.cnblogs.com/zhoujinyi/p/10387581.html">MySQL é«˜å¯ç”¨å¤åˆ¶ç®¡ç†å·¥å…· â€”â€” Orchestrator ä»‹ç»</a>ã€ã€‚åœ¨æ‰§è¡Œæ•…éšœæ£€æµ‹å’Œæ¢å¤çš„æ—¶å€™éƒ½å¯ä»¥æ‰§è¡Œå¤–éƒ¨è‡ªå®šä¹‰è„šæœ¬ï¼ˆhooksï¼‰ï¼Œæ¥é…åˆä½¿ç”¨ï¼ˆVIPã€Proxyã€DNSï¼‰ã€‚</p>
<p><strong>å¯ä»¥æ¢å¤ä¸­ç»§ä¸»åº“ï¼ˆDeadIntermediateMasterï¼‰å’Œä¸»åº“ï¼š</strong></p>
<p>ä¸­ç»§ä¸»åº“ï¼šæ¢å¤ä¼šæ‰¾å…¶åŒçº§çš„èŠ‚ç‚¹è¿›è¡Œåšä¸»ä»ã€‚åŒ¹é…å‰¯æœ¬æŒ‰ç…§å“ªäº›å®ä¾‹å…·æœ‰ log-slave-updatesã€å®ä¾‹æ˜¯å¦å»¶è¿Ÿã€å®ƒä»¬æ˜¯å¦å…·æœ‰å¤åˆ¶è¿‡æ»¤å™¨ã€å“ªäº›ç‰ˆæœ¬çš„ MySQL ç­‰ç­‰</p>
<p>ä¸»åº“ï¼šæ¢å¤å¯ä»¥æŒ‡å®šæå‡ç‰¹å®šçš„ä»åº“ã€Œæå‡è§„åˆ™ã€ï¼ˆregister-candidateï¼‰ï¼Œæå‡çš„ä»åº“ä¸ä¸€å®šæ˜¯æœ€æ–°çš„ï¼Œè€Œæ˜¯é€‰æ‹©æœ€åˆé€‚çš„ï¼Œè®¾ç½®å®Œæå‡è§„åˆ™ä¹‹åï¼Œæœ‰æ•ˆæœŸä¸º 1 ä¸ªå°æ—¶ã€‚</p>
<p>æå‡è§„åˆ™é€‰é¡¹æœ‰ï¼š</p>
<pre><code>prefer      --æ¯”è¾ƒå–œæ¬¢
neutral    --ä¸­ç«‹ï¼ˆé»˜è®¤ï¼‰
prefer_not --æ¯”è¾ƒä¸å–œæ¬¢
must_not  --æ‹’ç»
</code></pre>
<p>æ¢å¤æ”¯æŒçš„ç±»å‹æœ‰ï¼š<a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md#automated-recovery">è‡ªåŠ¨æ¢å¤</a>ã€<a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md#graceful-master-promotion">ä¼˜é›…çš„æ¢å¤</a>ã€<a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md#manual-recovery">æ‰‹åŠ¨æ¢å¤</a>ã€<a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md#manual-forced-failover">æ‰‹åŠ¨å¼ºåˆ¶æ¢å¤</a>ï¼Œæ¢å¤çš„æ—¶å€™ä¹Ÿå¯ä»¥æ‰§è¡Œç›¸åº”çš„ <a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md#recovery-hooks">Hooks å‚æ•°</a>ã€‚å…·ä½“çš„æ¢å¤æµç¨‹å¯ä»¥çœ‹**<a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md">æ¢å¤æµç¨‹</a>**çš„è¯´æ˜ã€‚å…³äº<a href="https://github.com/github/orchestrator/blob/master/docs/configuration-recovery.md">æ¢å¤çš„é…ç½®</a>å¯ä»¥<a href="https://github.com/github/orchestrator/blob/master/docs/configuration-recovery.md">å®˜æ–¹è¯´æ˜</a>ã€‚</p>
<p>**è¡¥å……ï¼š**æ¯æ¬¡æ¢å¤é™¤äº†è‡ªåŠ¨çš„ Failover ä¹‹å¤–ï¼Œéƒ½éœ€è¦é…åˆæ‰§è¡Œè‡ªå·±å®šä¹‰çš„ Hooks çš„è„šæœ¬æ¥å¤„ç†å¤–éƒ¨çš„ä¸€äº›æ“ä½œï¼šVIP ä¿®æ”¹ã€DNS ä¿®æ”¹ã€Proxy ä¿®æ”¹ç­‰ç­‰ã€‚æ‰€ä»¥è¿™ä¹ˆå¤š Hooks çš„å‚æ•°è¯¥å¦‚ä½•è®¾ç½®å‘¢ï¼Ÿå“ªä¸ªå‚æ•°éœ€è¦æ‰§è¡Œï¼Œå“ªä¸ªå‚æ•°ä¸éœ€è¦æ‰§è¡Œï¼Œä»¥åŠ Hooks çš„æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿè™½ç„¶æ–‡ç« é‡Œæœ‰ä»‹ç»ï¼Œä½†ä¸ºäº†æ›´å¥½çš„è¿›è¡Œè¯´æ˜ï¼Œä¸‹é¢è¿›è¡Œå„ç§æ¢å¤åœºæ™¯æ‰§è¡Œ Hooks çš„é¡ºåºï¼š</p>
<pre><code>   &quot;OnFailureDetectionProcesses&quot;: [   #æ£€æµ‹æ•…éšœæ—¶æ‰§è¡Œ
    &quot;echo 'â‘¡  Detected {failureType} on {failureCluster}. Affected replicas: {countSlaves}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PreGracefulTakeoverProcesses&quot;: [   #åœ¨ä¸»å˜ä¸ºåªè¯»ä¹‹å‰ç«‹å³æ‰§è¡Œ
    &quot;echo 'â‘    Planned takeover about to take place on {failureCluster}. Master will switch to read_only' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PreFailoverProcesses&quot;: [   #åœ¨æ‰§è¡Œæ¢å¤æ“ä½œä¹‹å‰ç«‹å³æ‰§è¡Œ
    &quot;echo 'â‘¢  Will recover from {failureType} on {failureCluster}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PostMasterFailoverProcesses&quot;: [ #åœ¨ä¸»æ¢å¤æˆåŠŸç»“æŸæ—¶æ‰§è¡Œ
    &quot;echo 'â‘£  Recovered from {failureType} on {failureCluster}. Failed: {failedHost}:{failedPort}; Promoted: {successorHost}:{successorPort}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PostFailoverProcesses&quot;: [   #åœ¨ä»»ä½•æˆåŠŸæ¢å¤ç»“æŸæ—¶æ‰§è¡Œ
    &quot;echo 'â‘¤  (for all types) Recovered from {failureType} on {failureCluster}. Failed: {failedHost}:{failedPort}; Successor: {successorHost}:{successorPort}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PostUnsuccessfulFailoverProcesses&quot;: [  #åœ¨ä»»ä½•ä¸æˆåŠŸçš„æ¢å¤ç»“æŸæ—¶æ‰§è¡Œ
    &quot;echo 'â‘§  &gt;&gt; /tmp/recovery.log'&quot;
  ],
  &quot;PostIntermediateMasterFailoverProcesses&quot;: [  #åœ¨æˆåŠŸçš„ä¸­é—´ä¸»æ¢å¤ç»“æŸæ—¶æ‰§è¡Œ
    &quot;echo 'â‘¥ Recovered from {failureType} on {failureCluster}. Failed: {failedHost}:{failedPort}; Successor: {successorHost}:{successorPort}' &gt;&gt; /tmp/recovery.log&quot;
  ],
  &quot;PostGracefulTakeoverProcesses&quot;: [   #åœ¨æ—§ä¸»ä½äºæ–°æ™‹å‡çš„ä¸»ä¹‹åæ‰§è¡Œ
    &quot;echo 'â‘¦ Planned takeover complete' &gt;&gt; /tmp/recovery.log&quot;
  ],
</code></pre>
<pre><code> ä¸»åº“å®•æœºï¼Œè‡ªåŠ¨Failover
â‘¡  Detected UnreachableMaster on test1:3307. Affected replicas: 2
â‘¡  Detected DeadMaster on test1:3307. Affected replicas: 2
â‘¢  Will recover from DeadMaster on test1:3307
â‘£  Recovered from DeadMaster on test1:3307. Failed: test1:3307; Promoted: test2:3307
â‘¤  (for all types) Recovered from DeadMaster on test1:3307. Failed: test1:3307; Successor: test2:3307

 ä¼˜é›…çš„ä¸»ä»åˆ‡æ¢ï¼štest2:3307ä¼˜é›…çš„åˆ‡æ¢åˆ°test1:3307ï¼Œåˆ‡æ¢ä¹‹åéœ€è¦æ‰‹åŠ¨æ‰§è¡Œstart slave
  orchestrator-client -c graceful-master-takeover -a test2:3307 -d test1:3307
â‘   Planned takeover about to take place on test2:3307. Master will switch to read_only
â‘¡  Detected DeadMaster on test2:3307. Affected replicas: 1
â‘¢  Will recover from DeadMaster on test2:3307
â‘£  Recovered from DeadMaster on test2:3307. Failed: test2:3307; Promoted: test1:3307
â‘¤  (for all types) Recovered from DeadMaster on test2:3307. Failed: test2:3307; Successor: test1:3307
â‘¦ Planned takeover complete

 æ‰‹åŠ¨æ¢å¤ï¼Œå½“ä»åº“è¿›å…¥åœæœºæˆ–åˆ™ç»´æŠ¤æ¨¡å¼ï¼Œæ­¤æ—¶ä¸»åº“å®•æœºï¼Œä¸ä¼šè‡ªåŠ¨Failoverï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œæ¢å¤ï¼ŒæŒ‡å®šæ­»æ‰çš„ä¸»å®ä¾‹ï¼š
  orchestrator-client -c recover -i test1:3307
â‘¡  Detected UnreachableMaster on test1:3307. Affected replicas: 2
â‘¡  Detected DeadMaster on test1:3307. Affected replicas: 2
â‘¢  Will recover from DeadMaster on test1:3307
â‘£  Recovered from DeadMaster on test1:3307. Failed: test1:3307; Promoted: test2:3307
â‘¤  (for all types) Recovered from DeadMaster on test1:3307. Failed: test1:3307; Successor: test2:3307

 æ‰‹åŠ¨å¼ºåˆ¶æ¢å¤ï¼Œä¸ç®¡ä»»ä½•æƒ…å†µï¼Œéƒ½è¿›è¡Œæ¢å¤ï¼š
  orchestrator-client -c force-master-failover -i test2:3307
â‘¡  Detected DeadMaster on test2:3307. Affected replicas: 2
â‘¢  Will recover from DeadMaster on test2:3307
â‘¡  Detected AllMasterSlavesNotReplicating on test2:3307. Affected replicas: 2
â‘£  Recovered from DeadMaster on test2:3307. Failed: test2:3307; Promoted: test1:3307
â‘¤  (for all types) Recovered from DeadMaster on test2:3307. Failed: test2:3307; Successor: test1:3307
</code></pre>
<p>å…¶ä¸­ä¸Šé¢çš„æƒ…å†µä¸‹ï¼Œâ‘¥å’Œâ‘§éƒ½æ²¡æ‰§è¡Œã€‚å› ä¸ºâ‘¥æ˜¯æ‰§è¡Œä¸­é—´ä¸»åº“æ—¶å€™æ‰§è¡Œçš„ï¼Œæ²¡æœ‰ä¸­é—´ä¸»åº“ï¼ˆçº§è”å¤åˆ¶ï¼‰å¯ä»¥ä¸ç”¨è®¾ç½®ã€‚â‘§æ˜¯æ¢å¤å¤±è´¥çš„æ—¶å€™æ‰§è¡Œçš„ï¼Œä¸Šé¢æ¢å¤æ²¡æœ‰å‡ºç°å¤±è´¥ï¼Œå¯ä»¥å®šä¹‰ä¸€äº›å‘Šè­¦æé†’ã€‚</p>
<h2 id="ç”Ÿäº§ç¯å¢ƒä¸Šéƒ¨ç½²">ç”Ÿäº§ç¯å¢ƒä¸Šéƒ¨ç½²</h2>
<p>åœ¨ç”Ÿäº§ä¸Šéƒ¨ç½² <a href="https://github.com/github/orchestrator">Orchestrator</a>ï¼Œå¯ä»¥å‚è€ƒ<a href="https://github.com/github/orchestrator/blob/master/docs/deployment.md">æ–‡æ¡£</a>ã€‚</p>
<p><strong>1.</strong> <a href="https://github.com/github/orchestrator">Orchestrator</a> é¦–å…ˆéœ€è¦ç¡®è®¤æœ¬èº«é«˜å¯ç”¨çš„åç«¯æ•°æ®åº“æ˜¯ç”¨å•ä¸ª MySQLï¼ŒMySQL å¤åˆ¶è¿˜æ˜¯æœ¬èº«çš„ Raftã€‚</p>
<p><strong>2.</strong> è¿è¡Œå‘ç°æœåŠ¡ï¼ˆwebã€orchestrator-clientï¼‰</p>
<pre><code>orchestrator-client -c discover -i this.hostname.com
</code></pre>
<p><strong>3.</strong> ç¡®å®šæå‡è§„åˆ™ï¼ˆæŸäº›æœåŠ¡å™¨æ›´é€‚åˆè¢«æå‡ï¼‰</p>
<pre><code>orchestrator -c register-candidate -i ${::fqdn} --promotion-rule ${promotion_rule}
</code></pre>
<p><strong>4.</strong> å¦‚æœæœåŠ¡å™¨å‡ºç°é—®é¢˜ï¼Œå°†åœ¨ Web ç•Œé¢ä¸Šçš„é—®é¢˜ä¸‹æ‹‰åˆ—è¡¨ä¸­æ˜¾ç¤ºã€‚ä½¿ç”¨ <a href="https://github.com/github/orchestrator/blob/master/docs/deployment.md#downtiming">Downtiming</a> åˆ™ä¸ä¼šåœ¨é—®é¢˜åˆ—è¡¨é‡Œæ˜¾ç¤ºï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šè¿›è¡Œæ¢å¤ï¼Œå¤„äºç»´æŠ¤æ¨¡å¼ã€‚</p>
<pre><code>orchestrator -c begin-downtime -i ${::fqdn} --duration=5m --owner=cron --reason=continuous_downtime&quot;

ä¹Ÿå¯ä»¥ç”¨APIï¼š
curl -s &quot;http://my.orchestrator.service:80/api/begin-downtime/my.hostname/3306/wallace/experimenting+failover/45m&quot;
</code></pre>
<p><strong>5.</strong> <a href="https://github.com/github/orchestrator/blob/master/docs/deployment.md#pseudo-gtid">ä¼ª GTID</a>ï¼Œå¦‚æœ MySQL æ²¡æœ‰å¼€å¯ GTIDï¼Œåˆ™å¯ä»¥å¼€å¯ä¼ª GTID å®ç°ç±»ä¼¼ GTID çš„åŠŸèƒ½ã€‚</p>
<p><strong>6.</strong> ä¿å­˜<a href="https://github.com/github/orchestrator/blob/master/docs/deployment.md#populating-meta-data">å…ƒæ•°æ®</a>ï¼Œå…ƒæ•°æ®å¤§éƒ¨åˆ†é€šè¿‡å‚æ•°çš„ query æ¥è·å–ï¼Œæ¯”å¦‚åœ¨è‡ªçš„è¡¨ cluster é‡Œè·å–é›†ç¾¤çš„åˆ«å (DetectClusterAliasQuery)ã€æ•°æ®ä¸­å¿ƒ(DetectDataCenterQuery)ã€åŸŸå(DetectClusterDomainQuery) ç­‰ï¼Œä»¥åŠå¤åˆ¶çš„å»¶è¿Ÿï¼ˆpt-heartbeatï¼‰ã€æ˜¯å¦åŠåŒæ­¥(DetectSemiSyncEnforcedQuery)ã€‚ä»¥åŠå¯ä»¥é€šè¿‡æ­£åˆ™åŒ¹é…ï¼šDataCenterPatternã€PhysicalEnvironmentPattern ç­‰ã€‚</p>
<p><strong>7.</strong> å¯ä»¥ç»™å®ä¾‹æ‰“<a href="https://github.com/github/orchestrator/blob/master/docs/tags.md">æ ‡ç­¾</a>ã€‚</p>
<h2 id="å‘½ä»¤è¡Œ-api-çš„ä½¿ç”¨">å‘½ä»¤è¡Œã€API çš„ä½¿ç”¨</h2>
<p><a href="https://github.com/github/orchestrator">Orchestrator</a> ä¸ä»…æœ‰ Web ç•Œé¢æ¥è¿›è¡ŒæŸ¥çœ‹å’Œç®¡ç†ï¼Œè¿˜å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œï¼ˆ<a href="https://github.com/github/orchestrator/blob/622e979722bf433232ae267727933ba055cdbfed/docs/orchestrator-client.md#orchestrator-client">orchestrator-client</a>ï¼‰å’Œ APIï¼ˆcurlï¼‰æ¥æ‰§è¡Œæ›´å¤šçš„ç®¡ç†å‘½ä»¤ï¼Œç°åœ¨æ¥è¯´æ˜å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨æ–¹æ³•ã€‚</p>
<p>é€šè¿‡ help æ¥çœ‹ä¸‹æœ‰å“ªäº›å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼š./orchestrator-client --helpï¼Œå‘½ä»¤çš„è¯´æ˜å¯ä»¥çœ‹<a href="https://github.com/github/orchestrator/blob/622e979722bf433232ae267727933ba055cdbfed/go/app/command_help.go">æ‰‹å†Œè¯´æ˜</a>ã€‚</p>
<pre><code>Usage: orchestrator-client -c &lt;command&gt; [flags...]
Example: orchestrator-client -c which-master -i some.replica
Options:

  -h, --help
    print this help
  -c &lt;command&gt;, --command &lt;command&gt;
    indicate the operation to perform (see listing below)
  -a &lt;alias&gt;, --alias &lt;alias&gt;
    cluster alias
  -o &lt;owner&gt;, --owner &lt;owner&gt;
    name of owner for downtime/maintenance commands
  -r &lt;reason&gt;, --reason &lt;reason&gt;
    reason for downtime/maintenance operation
  -u &lt;duration&gt;, --duration &lt;duration&gt;
    duration for downtime/maintenance operations
  -R &lt;promotion rule&gt;, --promotion-rule &lt;promotion rule&gt;
    rule for 'register-candidate' command
  -U &lt;orchestrator_api&gt;, --api &lt;orchestrator_api&gt;
    override $orchestrator_api environemtn variable,
    indicate where the client should connect to.
  -P &lt;api path&gt;, --path &lt;api path&gt;
    With '-c api', indicate the specific API path you wish to call
  -b &lt;username:password&gt;, --auth &lt;username:password&gt;
    Specify when orchestrator uses basic HTTP auth.
  -q &lt;query&gt;, --query &lt;query&gt;
    Indicate query for 'restart-replica-statements' command
  -l &lt;pool name&gt;, --pool &lt;pool name&gt;
    pool name for pool related commands
  -H &lt;hostname&gt; -h &lt;hostname&gt;
    indicate host for resolve and raft operations

    help                                     Show available commands
    which-api                                Output the HTTP API to be used
    api                                      Invoke any API request; provide --path argument
    async-discover                           Lookup an instance, investigate it asynchronously. Useful for bulk loads
    discover                                 Lookup an instance, investigate it
    forget                                   Forget about an instance's existence
    forget-cluster                           Forget about a cluster
    topology                                 Show an ascii-graph of a replication topology, given a member of that topology
    topology-tabulated                       Show an ascii-graph of a replication topology, given a member of that topology, in tabulated format
    clusters                                 List all clusters known to orchestrator
    clusters-alias                           List all clusters known to orchestrator
    search                                   Search for instances matching given substring
    instance&quot;|&quot;which-instance                Output the fully-qualified hostname:port representation of the given instance, or error if unknown
    which-master                             Output the fully-qualified hostname:port representation of a given instance's master
    which-replicas                           Output the fully-qualified hostname:port list of replicas of a given instance
    which-broken-replicas                    Output the fully-qualified hostname:port list of broken replicas of a given instance
    which-cluster-instances                  Output the list of instances participating in same cluster as given instance
    which-cluster                            Output the name of the cluster an instance belongs to, or error if unknown to orchestrator
    which-cluster-master                     Output the name of a writable master in given cluster
    all-clusters-masters                     List of writeable masters, one per cluster
    all-instances                            The complete list of known instances
    which-cluster-osc-replicas               Output a list of replicas in a cluster, that could serve as a pt-online-schema-change operation control replicas
    which-cluster-osc-running-replicas       Output a list of healthy, replicating replicas in a cluster, that could serve as a pt-online-schema-change operation control replicas
    downtimed                                List all downtimed instances
    dominant-dc                              Name the data center where most masters are found
    submit-masters-to-kv-stores              Submit a cluster's master, or all clusters' masters to KV stores
    relocate                                 Relocate a replica beneath another instance
    relocate-replicas                        Relocates all or part of the replicas of a given instance under another instance
    match                                    Matches a replica beneath another (destination) instance using Pseudo-GTID
    match-up                                 Transport the replica one level up the hierarchy, making it child of its grandparent, using Pseudo-GTID
    match-up-replicas                        Matches replicas of the given instance one level up the topology, making them siblings of given instance, using Pseudo-GTID
    move-up                                  Move a replica one level up the topology
    move-below                               Moves a replica beneath its sibling. Both replicas must be actively replicating from same master.
    move-equivalent                          Moves a replica beneath another server, based on previously recorded &quot;equivalence coordinates&quot;
    move-up-replicas                         Moves replicas of the given instance one level up the topology
    make-co-master                           Create a master-master replication. Given instance is a replica which replicates directly from a master.
    take-master                              Turn an instance into a master of its own master; essentially switch the two.
    move-gtid                                Move a replica beneath another instance via GTID
    move-replicas-gtid                       Moves all replicas of a given instance under another (destination) instance using GTID
    repoint                                  Make the given instance replicate from another instance without changing the binglog coordinates. Use with care
    repoint-replicas                         Repoint all replicas of given instance to replicate back from the instance. Use with care
    take-siblings                            Turn all siblings of a replica into its sub-replicas.
    tags                                     List tags for a given instance
    tag-value                                List tags for a given instance
    tag                                      Add a tag to a given instance. Tag in &quot;tagname&quot; or &quot;tagname=tagvalue&quot; format
    untag                                    Remove a tag from an instance
    untag-all                                Remove a tag from all matching instances
    tagged                                   List instances tagged by tag-string. Format: &quot;tagname&quot; or &quot;tagname=tagvalue&quot; or comma separated &quot;tag0,tag1=val1,tag2&quot; for intersection of all.
    submit-pool-instances                    Submit a pool name with a list of instances in that pool
    which-heuristic-cluster-pool-instances   List instances of a given cluster which are in either any pool or in a specific pool
    begin-downtime                           Mark an instance as downtimed
    end-downtime                             Indicate an instance is no longer downtimed
    begin-maintenance                        Request a maintenance lock on an instance
    end-maintenance                          Remove maintenance lock from an instance
    register-candidate                       Indicate the promotion rule for a given instance
    register-hostname-unresolve              Assigns the given instance a virtual (aka &quot;unresolved&quot;) name
    deregister-hostname-unresolve            Explicitly deregister/dosassociate a hostname with an &quot;unresolved&quot; name
    stop-replica                             Issue a STOP SLAVE on an instance
    stop-replica-nice                        Issue a STOP SLAVE on an instance, make effort to stop such that SQL thread is in sync with IO thread (ie all relay logs consumed)
    start-replica                            Issue a START SLAVE on an instance
    restart-replica                          Issue STOP and START SLAVE on an instance
    reset-replica                            Issues a RESET SLAVE command; use with care
    detach-replica                           Stops replication and modifies binlog position into an impossible yet reversible value.
    reattach-replica                         Undo a detach-replica operation
    detach-replica-master-host               Stops replication and modifies Master_Host into an impossible yet reversible value.
    reattach-replica-master-host             Undo a detach-replica-master-host operation
    skip-query                               Skip a single statement on a replica; either when running with GTID or without
    gtid-errant-reset-master                 Remove errant GTID transactions by way of RESET MASTER
    gtid-errant-inject-empty                 Apply errant GTID as empty transactions on cluster's master
    enable-semi-sync-master                  Enable semi-sync (master-side)
    disable-semi-sync-master                 Disable semi-sync (master-side)
    enable-semi-sync-replica                 Enable semi-sync (replica-side)
    disable-semi-sync-replica                Disable semi-sync (replica-side)
    restart-replica-statements               Given `-q &quot;&lt;query&gt;&quot;` that requires replication restart to apply, wrap query with stop/start slave statements as required to restore instance to same replication state. Print out set of statements
    can-replicate-from                       Check if an instance can potentially replicate from another, according to replication rules
    can-replicate-from-gtid                  Check if an instance can potentially replicate from another, according to replication rules and assuming Oracle GTID
    is-replicating                           Check if an instance is replicating at this time (both SQL and IO threads running)
    is-replication-stopped                   Check if both SQL and IO threads state are both strictly stopped.
    set-read-only                            Turn an instance read-only, via SET GLOBAL read_only := 1
    set-writeable                            Turn an instance writeable, via SET GLOBAL read_only := 0
    flush-binary-logs                        Flush binary logs on an instance
    last-pseudo-gtid                         Dump last injected Pseudo-GTID entry on a server
    recover                                  Do auto-recovery given a dead instance, assuming orchestrator agrees there's a problem. Override blocking.
    graceful-master-takeover                 Gracefully promote a new master. Either indicate identity of new master via '-d designated.instance.com' or setup replication tree to have a single direct replica to the master.
    force-master-failover                    Forcibly discard master and initiate a failover, even if orchestrator doesn't see a problem. This command lets orchestrator choose the replacement master
    force-master-takeover                    Forcibly discard master and promote another (direct child) instance instead, even if everything is running well
    ack-cluster-recoveries                   Acknowledge recoveries for a given cluster; this unblocks pending future recoveries
    ack-all-recoveries                       Acknowledge all recoveries
    disable-global-recoveries                Disallow orchestrator from performing recoveries globally
    enable-global-recoveries                 Allow orchestrator to perform recoveries globally
    check-global-recoveries                  Show the global recovery configuration
    replication-analysis                     Request an analysis of potential crash incidents in all known topologies
    raft-leader                              Get identify of raft leader, assuming raft setup
    raft-health                              Whether node is part of a healthy raft group
    raft-leader-hostname                     Get hostname of raft leader, assuming raft setup
    raft-elect-leader                        Request raft re-elections, provide hint for new leader's identity
</code></pre>
<p><a href="https://github.com/github/orchestrator/blob/622e979722bf433232ae267727933ba055cdbfed/docs/orchestrator-client.md#orchestrator-client">orchestrator-client</a> ä¸éœ€è¦å’Œ <a href="https://github.com/github/orchestrator">Orchestrator</a> æœåŠ¡æ”¾ä¸€èµ·ï¼Œä¸éœ€è¦è®¿é—®åç«¯æ•°æ®åº“ï¼Œåœ¨ä»»æ„ä¸€å°ä¸Šéƒ½å¯ä»¥ã€‚</p>
<p>**æ³¨æ„ï¼š**å› ä¸ºé…ç½®äº† Raftï¼Œæœ‰å¤šä¸ª Orchestratorï¼Œæ‰€ä»¥éœ€è¦ ORCHESTRATOR_API çš„ç¯å¢ƒå˜é‡ï¼Œorchestrator-client ä¼šè‡ªåŠ¨é€‰æ‹© leaderã€‚å¦‚ï¼š</p>
<pre><code>export ORCHESTRATOR_API=&quot;test1:3000/api test2:3000/api test3:3000/api&quot;
</code></pre>
<ol>
<li>åˆ—å‡ºæ‰€æœ‰é›†ç¾¤ï¼šclusters</li>
</ol>
<p>é»˜è®¤ï¼š</p>
<pre><code># orchestrator-client -c clusters
test2:3307
</code></pre>
<p>è¿”å›åŒ…å«é›†ç¾¤åˆ«åï¼šclusters-alias</p>
<pre><code># orchestrator-client -c clusters-alias
test2:3307,test
</code></pre>
<ol start="2">
<li>å‘ç°æŒ‡å®šå®ä¾‹ï¼šdiscover/async-discover</li>
</ol>
<p>åŒæ­¥ç°ï¼š</p>
<pre><code># orchestrator-client -c discover -i test1:3307
test1:3307
</code></pre>
<p>å¼‚æ­¥å‘ç°ï¼šé€‚ç”¨äºæ‰¹é‡</p>
<pre><code># orchestrator-client -c async-discover -i test1:3307
:null
</code></pre>
<ol start="3">
<li>å¿˜è®°æŒ‡å®šå¯¹è±¡ï¼šforget/forget-cluster</li>
</ol>
<p>å¿˜è®°æŒ‡å®šå®ä¾‹ï¼š</p>
<pre><code># orchestrator-client -c forget -i test1:3307
</code></pre>
<p>å¿˜è®°æŒ‡å®šé›†ç¾¤ï¼š</p>
<pre><code># orchestrator-client -c forget-cluster -i test
</code></pre>
<ol start="4">
<li>æ‰“å°æŒ‡å®šé›†ç¾¤çš„æ‹“æ‰‘ï¼štopology/topology-tabulated</li>
</ol>
<p>æ™®é€šè¿”å›ï¼š</p>
<pre><code># orchestrator-client -c topology -i test1:3307
test2:3307   [0s,ok,5.7.25-0ubuntu0.16.04.2-log,rw,ROW,&gt;&gt;,GTID]
+ test1:3307 [0s,ok,5.7.25-0ubuntu0.16.04.2-log,ro,ROW,&gt;&gt;,GTID]
+ test3:3307 [0s,ok,5.7.25-log,ro,ROW,&gt;&gt;,GTID]
</code></pre>
<p>åˆ—è¡¨è¿”å›ï¼š</p>
<pre><code># orchestrator-client -c topology-tabulated -i test1:3307
test2:3307  |0s|ok|5.7.25-0ubuntu0.16.04.2-log|rw|ROW|&gt;&gt;,GTID
+ test1:3307|0s|ok|5.7.25-0ubuntu0.16.04.2-log|ro|ROW|&gt;&gt;,GTID
+ test3:3307|0s|ok|5.7.25-log                 |ro|ROW|&gt;&gt;,GTID
</code></pre>
<ol start="5">
<li>æŸ¥çœ‹ä½¿ç”¨å“ªä¸ª APIï¼šè‡ªå·±ä¼šé€‰æ‹©å‡º leaderã€‚which-api</li>
</ol>
<pre><code># orchestrator-client -c which-api
test3:3000/api
</code></pre>
<p>ä¹Ÿå¯ä»¥é€šè¿‡ http://192.168.163.133:3000/api/leader-check æŸ¥çœ‹ã€‚</p>
<ol start="6">
<li>è°ƒç”¨api è¯·æ±‚ï¼Œéœ€è¦å’Œ -path å‚æ•°ä¸€èµ·ï¼šapi..-path</li>
</ol>
<pre><code># orchestrator-client -c api -path clusters
[ &quot;test2:3307&quot; ]
# orchestrator-client -c api -path leader-check &quot;OK&quot;
# orchestrator-client -c api -path status
{ &quot;Code&quot;: &quot;OK&quot;, &quot;Message&quot;: &quot;Application node is healthy&quot;...}
</code></pre>
<ol start="7">
<li>æœç´¢å®ä¾‹ï¼šsearch</li>
</ol>
<pre><code># orchestrator-client -c search -i test
test2:3307
test1:3307
test3:3307
</code></pre>
<ol start="8">
<li>æ‰“å°æŒ‡å®šå®ä¾‹çš„ä¸»åº“ï¼šwhich-master</li>
</ol>
<pre><code># orchestrator-client -c which-master -i test1:3307
test2:3307
# orchestrator-client -c which-master -i test3:3307
test2:3307
# orchestrator-client -c which-master -i test2:3307 #è‡ªå·±æœ¬èº«æ˜¯ä¸»åº“
:0
</code></pre>
<ol start="9">
<li>æ‰“å°æŒ‡å®šå®ä¾‹çš„ä»åº“ï¼šwhich-replicas</li>
</ol>
<pre><code># orchestrator-client -c which-replicas -i test2:3307
test1:3307
test3:3307
</code></pre>
<ol start="10">
<li>æ‰“å°æŒ‡å®šå®ä¾‹çš„å®ä¾‹åï¼šwhich-instance</li>
</ol>
<pre><code># orchestrator-client -c instance -i test1:3307
test1:3307
</code></pre>
<ol start="11">
<li>æ‰“å°æŒ‡å®šä¸»å®ä¾‹ä»åº“å¼‚å¸¸çš„åˆ—è¡¨ï¼šwhich-broken-replicasï¼Œæ¨¡æ‹Ÿ test3 çš„å¤åˆ¶å¼‚å¸¸ï¼š</li>
</ol>
<pre><code># orchestrator-client -c which-broken-replicas -i test2:3307
test3:3307
</code></pre>
<ol start="12">
<li>ç»™å‡ºä¸€ä¸ªå®ä¾‹æˆ–åˆ™é›†ç¾¤åˆ«åï¼Œæ‰“å°å‡ºè¯¥å®ä¾‹æ‰€åœ¨é›†ç¾¤ä¸‹çš„æ‰€æœ‰å…¶ä»–å®ä¾‹ã€‚which-cluster-instances</li>
</ol>
<pre><code># orchestrator-client -c which-cluster-instances -i test
test1:3307
test2:3307
test3:3307
root@test1:~# orchestrator-client -c which-cluster-instances -i test1:3307
test1:3307
test2:3307
test3:3307
</code></pre>
<ol start="13">
<li>ç»™å‡ºä¸€ä¸ªå®ä¾‹ï¼Œæ‰“å°è¯¥å®çš„é›†ç¾¤åç§°ï¼šé»˜è®¤æ˜¯ hostname:portã€‚which-cluster</li>
</ol>
<pre><code># orchestrator-client -c which-cluster -i test1:3307
test2:3307# orchestrator-client -c which-cluster -i test2:3307
test2:3307# orchestrator-client -c which-cluster -i test3:3307
test2:3307
</code></pre>
<ol start="14">
<li>æ‰“å°å‡ºæŒ‡å®šå®ä¾‹ / é›†ç¾¤åæˆ–åˆ™æ‰€æœ‰æ‰€åœ¨é›†ç¾¤çš„å¯å†™å®ä¾‹ï¼Œï¼šwhich-cluster-master</li>
</ol>
<p>æŒ‡å®šå®ä¾‹ï¼šwhich-cluster-master</p>
<pre><code># orchestrator-client -c which-cluster-master -i test2:3307
test2:3307
# orchestrator-client -c which-cluster-master -i test
test2:3307
</code></pre>
<p>æ‰€æœ‰å®ä¾‹ï¼šall-clusters-mastersï¼Œæ¯ä¸ªé›†ç¾¤è¿”å›ä¸€ä¸ª</p>
<pre><code># orchestrator-client -c all-clusters-masters
test1:3307
</code></pre>
<ol start="15">
<li>æ‰“å°å‡ºæ‰€æœ‰å®ä¾‹ï¼šall-instances</li>
</ol>
<pre><code># orchestrator-client -c all-instances
test2:3307
test1:3307
test3:3307
</code></pre>
<ol start="16">
<li>æ‰“å°å‡ºé›†ç¾¤ä¸­å¯ä»¥ä½œä¸º pt-online-schema-change æ“ä½œçš„å‰¯æœ¬åˆ—è¡¨ï¼šwhich-cluster-osc-replicas</li>
</ol>
<pre><code>~# orchestrator-client -c which-cluster-osc-replicas -i test
test1:3307
test3:3307
root@test1:~# orchestrator-client -c which-cluster-osc-replicas -i test2:3307
test1:3307
test3:3307
</code></pre>
<ol start="17">
<li>æ‰“å°å‡ºé›†ç¾¤ä¸­å¯ä»¥ä½œä¸º pt-online-schema-change å¯ä»¥æ“ä½œçš„å¥åº·çš„å‰¯æœ¬åˆ—è¡¨ï¼šwhich-cluster-osc-running-replicas</li>
</ol>
<pre><code># orchestrator-client -c which-cluster-osc-running-replicas -i test
test1:3307
test3:3307
# orchestrator-client -c which-cluster-osc-running-replicas -i test1:3307
test1:3307
test3:3307
</code></pre>
<ol start="18">
<li>æ‰“å°å‡ºæ‰€æœ‰åœ¨ç»´æŠ¤ï¼ˆdowntimedï¼‰çš„å®ä¾‹ï¼šdowntimed</li>
</ol>
<pre><code># orchestrator-client -c downtimed
test1:3307
test3:3307
</code></pre>
<ol start="19">
<li>æ‰“å°å‡ºè¿›ç¾¤ä¸­ä¸»çš„æ•°æ®ä¸­å¿ƒï¼šdominant-dc</li>
</ol>
<pre><code># orchestrator-client -c dominant-dc
BJ
</code></pre>
<ol start="20">
<li>å°†é›†ç¾¤çš„ä¸»æäº¤åˆ° KV å­˜å‚¨ã€‚submit-masters-to-kv-stores</li>
</ol>
<pre><code># orchestrator-client -c submit-masters-to-kv-stores 
mysql/master/test:test2:3307
mysql/master/test/hostname:test2
mysql/master/test/port:3307
mysql/master/test/ipv4:192.168.163.132
mysql/master/test/ipv6:
</code></pre>
<ol start="21">
<li>è¿ç§»ä»åº“åˆ°å¦ä¸€ä¸ªå®ä¾‹ä¸Šï¼šrelocate</li>
</ol>
<pre><code># orchestrator-client -c relocate -i test3:3307 -d test1:3307 #è¿ç§»test3:3307ä½œä¸ºtest1:3307çš„ä»åº“
test3:3307&lt;test1:3307

æŸ¥çœ‹
# orchestrator-client -c topology -i test2:3307
test2:3307     [0s,ok,5.7.25-0ubuntu0.16.04.2-log,rw,ROW,&gt;&gt;,GTID]
+ test1:3307   [0s,ok,5.7.25-0ubuntu0.16.04.2-log,ro,ROW,&gt;&gt;,GTID]
  + test3:3307 [0s,ok,5.7.25-log,ro,ROW,&gt;&gt;,GTID]
</code></pre>
<ol start="22">
<li>è¿ç§»ä¸€ä¸ªå®ä¾‹çš„æ‰€æœ‰ä»åº“åˆ°å¦ä¸€ä¸ªå®ä¾‹ä¸Šï¼šrelocate-replicas</li>
</ol>
<pre><code># orchestrator-client -c relocate-replicas -i test1:3307 -d test2:3307 #è¿ç§»test1:3307ä¸‹çš„æ‰€æœ‰ä»åº“åˆ°test2:3307ä¸‹ï¼Œå¹¶åˆ—å‡ºè¢«è¿ç§»çš„ä»åº“çš„å®ä¾‹å
test3:3307
</code></pre>
<ol start="23">
<li>å°† slave åœ¨æ‹“æ‰‘ä¸Šå‘ä¸Šç§»åŠ¨ä¸€çº§ï¼Œå¯¹åº” web ä¸Šçš„æ˜¯åœ¨ Classic Model ä¸‹è¿›è¡Œæ‹–åŠ¨ï¼šmove-up</li>
</ol>
<pre><code># orchestrator-client -c move-up -i test3:3307 -d test2:3307
test3:3307&lt;test2:3307
</code></pre>
<p>ç»“æ„ä» test2:3307 -&gt; test1:3307 -&gt; test3:3307 å˜æˆ test2:3307 -&gt; test1:3307</p>
<p>-&gt; test3:3307</p>
<ol start="24">
<li>å°† slave åœ¨æ‹“æ‰‘ä¸Šå‘ä¸‹ç§»åŠ¨ä¸€çº§ï¼ˆç§»åˆ°åŒçº§çš„ä¸‹é¢ï¼‰ï¼Œå¯¹åº” web ä¸Šçš„æ˜¯åœ¨ Classic Model ä¸‹è¿›è¡Œæ‹–åŠ¨ï¼šmove-below</li>
</ol>
<pre><code># orchestrator-client -c move-below -i test3:3307 -d test1:3307
test3:3307&lt;test1:3307
</code></pre>
<p>ç»“æ„ä» test2:3307 -&gt; test1:3307 å˜æˆ test2:3307 -&gt; test1:3307 -&gt; test3:3307</p>
<p>-&gt; test3:3307</p>
<ol start="25">
<li>å°†ç»™å®šå®ä¾‹çš„æ‰€æœ‰ä»åº“åœ¨æ‹“æ‰‘ä¸Šå‘ä¸Šç§»åŠ¨ä¸€çº§ï¼ŒåŸºäº Classic Model æ¨¡å¼ï¼šmove-up-replicas</li>
</ol>
<pre><code># orchestrator-client -c move-up-replicas -i test1:3307
 test3:3307
</code></pre>
<p>ç»“æ„ä» test2:3307 -&gt; test1:3307 -&gt; test3:3307 å˜æˆ test2:3307 -&gt; test1:3307</p>
<p>-&gt; test3:3307</p>
<ol start="26">
<li>åˆ›å»ºä¸»ä¸»å¤åˆ¶ï¼Œå°†ç»™å®šå®ä¾‹ç›´æ¥å’Œå½“å‰ä¸»åº“åšæˆä¸»ä¸»å¤åˆ¶ï¼šmake-co-master</li>
</ol>
<pre><code># orchestrator-client -c make-co-master -i test1:3307
test1:3307&lt;test2:3307
</code></pre>
<ol start="27">
<li>å°†å®ä¾‹è½¬æ¢ä¸ºè‡ªå·±ä¸»äººçš„ä¸»äººï¼Œåˆ‡æ¢ä¸¤ä¸ªï¼štake-master</li>
</ol>
<pre><code># orchestrator-client -c take-master -i test3:3307
test3:3307&lt;test2:3307
</code></pre>
<p>ç»“æ„ä» test2:3307 -&gt; test1:3307 -&gt; test3:3307 å˜æˆ test2:3307 -&gt; test3:3307 -&gt; test1:3307</p>
<ol start="28">
<li>é€šè¿‡ GTID ç§»åŠ¨å‰¯æœ¬ï¼Œmove-gtidï¼š</li>
</ol>
<p>é€šè¿‡ <a href="https://github.com/github/orchestrator/blob/622e979722bf433232ae267727933ba055cdbfed/docs/orchestrator-client.md#orchestrator-client">orchestrator-client</a> æ‰§è¡ŒæŠ¥é”™ï¼š</p>
<pre><code># orchestrator-client -c move-gtid -i test3:3307 -d test1:3307
parse error: Invalid numeric literal at line 1, column 9
parse error: Invalid numeric literal at line 1, column 9
parse error: Invalid numeric literal at line 1, column 9
</code></pre>
<p>é€šè¿‡ orchestrator æ‰§è¡Œæ˜¯æ²¡é—®é¢˜ï¼Œéœ€è¦æ·»åŠ  --ignore-raft-setup å‚æ•°ï¼š</p>
<pre><code># orchestrator -c move-gtid -i test3:3307 -d test2:3307 --ignore-raft-setup
test3:3307&lt;test2:3307
</code></pre>
<ol start="29">
<li>é€šè¿‡ GTID ç§»åŠ¨æŒ‡å®šå®ä¾‹ä¸‹çš„æ‰€æœ‰ slaves åˆ°å¦ä¸€ä¸ªå®ä¾‹ï¼Œmove-replicas-gtid</li>
</ol>
<p>é€šè¿‡ <a href="https://github.com/github/orchestrator/blob/622e979722bf433232ae267727933ba055cdbfed/docs/orchestrator-client.md#orchestrator-client">orchestrator-client</a> æ‰§è¡ŒæŠ¥é”™ï¼š</p>
<pre><code># orchestrator-client -c move-replicas-gtid -i test3:3307 -d test1:3307
jq: error (at &lt;stdin&gt;:1): Cannot index string with string &quot;Key&quot;
</code></pre>
<p>é€šè¿‡ orchestrator æ‰§è¡Œæ˜¯æ²¡é—®é¢˜ï¼Œéœ€è¦æ·»åŠ  --ignore-raft-setup å‚æ•°ï¼š</p>
<pre><code># ./orchestrator -c move-replicas-gtid -i test2:3307 -d test1:3307 --ignore-raft-setup
test3:3307
</code></pre>
<ol start="30">
<li>å°†ç»™å®šå®ä¾‹çš„åŒçº§ slaveï¼Œå˜æ›´æˆä»–çš„ slaveï¼Œtake-siblings</li>
</ol>
<pre><code># orchestrator-client -c take-siblings -i test3:3307
test3:3307&lt;test1:3307
</code></pre>
<p>ç»“æ„ä» test1:3307 -&gt; test2:3307 å˜æˆ test1:3307 -&gt; test3:3307 -&gt; test2:3307</p>
<p>-&gt; test3:3307</p>
<ol start="31">
<li>ç»™æŒ‡å®šå®ä¾‹æ‰“ä¸Šæ ‡ç­¾ï¼Œtag</li>
</ol>
<pre><code># orchestrator-client -c tag -i test1:3307 --tag 'name=AAA'
test1:3307 
</code></pre>
<ol start="32">
<li>åˆ—å‡ºæŒ‡å®šå®ä¾‹çš„æ ‡ç­¾ï¼Œtagsï¼š</li>
</ol>
<pre><code># orchestrator-client -c tags -i test1:3307
name=AAA 
</code></pre>
<ol start="33">
<li>åˆ—å‡ºç»™å®šå®ä¾‹çš„æ ‡ç­¾å€¼ï¼štag-value</li>
</ol>
<pre><code># orchestrator-client -c tag-value -i test1:3307 --tag &quot;name&quot;
AAA
</code></pre>
<ol start="34">
<li>ç§»é™¤æŒ‡å®šå®ä¾‹ä¸Šçš„æ ‡ç­¾ï¼šuntag</li>
</ol>
<pre><code># orchestrator-client -c untag -i test1:3307 --tag &quot;name=AAA&quot;
test1:3307 
</code></pre>
<ol start="35">
<li>åˆ—å‡ºæ‰“è¿‡æŸä¸ªæ ‡ç­¾çš„å®ä¾‹ï¼Œtaggedï¼š</li>
</ol>
<pre><code># orchestrator-client -c tagged -t name
test3:3307
test1:3307
test2:3307
</code></pre>
<ol start="36">
<li>æ ‡è®°æŒ‡å®šå®ä¾‹è¿›å…¥åœç”¨æ¨¡å¼ï¼ŒåŒ…æ‹¬æ—¶é—´ã€æ“ä½œäººã€å’ŒåŸå› ï¼Œbegin-downtimeï¼š</li>
</ol>
<pre><code># orchestrator-client -c begin-downtime -i test1:3307 -duration=10m -owner=zjy -reason 'test'
test1:3307
</code></pre>
<ol start="37">
<li>ç§»é™¤æŒ‡å®šå®ä¾‹çš„åœç”¨æ¨¡å¼ï¼Œend--downtimeï¼š</li>
</ol>
<pre><code># orchestrator-client -c end-downtime -i test1:3307
test1:3307
</code></pre>
<ol start="38">
<li>è¯·æ±‚æŒ‡å®šå®ä¾‹ä¸Šçš„ç»´æŠ¤é”ï¼šæ‹“æ‰‘æ›´æ”¹éœ€è¦å°†é”æ”¾åœ¨æœ€å°å—å½±å“çš„å®ä¾‹ä¸Šï¼Œä»¥é¿å…åœ¨åŒä¸€ä¸ªå®ä¾‹ä¸Šå‘ç”Ÿä¸¤ä¸ªä¸åè°ƒçš„æ“ä½œï¼Œbegin-maintenance ï¼š</li>
</ol>
<pre><code># orchestrator-client -c begin-maintenance -i test1:3307 --reason &quot;XXX&quot;
test1:3307
</code></pre>
<p>é”é»˜è®¤ 10 åˆ†é’Ÿåè¿‡æœŸï¼Œæœ‰å‚æ•° MaintenanceExpireMinutesã€‚</p>
<ol start="39">
<li>ç§»é™¤æŒ‡å®šå®ä¾‹ä¸Šçš„ç»´æŠ¤é”ï¼šend-maintenance</li>
</ol>
<pre><code># orchestrator-client -c end-maintenance -i test1:3307
test1:3307
</code></pre>
<ol start="40">
<li>è®¾ç½®æå‡è§„åˆ™ï¼Œæ¢å¤æ—¶å¯ä»¥æŒ‡å®šä¸€ä¸ªå®ä¾‹è¿›è¡Œæå‡ï¼šregister-candidateï¼šéœ€è¦å’Œ promotion-rule ä¸€èµ·ä½¿ç”¨</li>
</ol>
<pre><code># orchestrator-client -c register-candidate -i test3:3307 --promotion-rule prefer 
test3:3307
</code></pre>
<p>æå‡ test3:3307 çš„æƒé‡ï¼Œå¦‚æœè¿›è¡Œ Failoverï¼Œä¼šæˆä¸º Masterã€‚</p>
<ol start="41">
<li>æŒ‡å®šå®ä¾‹æ‰§è¡Œåœæ­¢å¤åˆ¶ï¼š</li>
</ol>
<p>æ™®é€šçš„ï¼šstop slaveï¼šstop-replica</p>
<pre><code># orchestrator-client -c stop-replica -i test2:3307
test2:3307
</code></pre>
<p>åº”ç”¨å®Œ relay logï¼Œåœ¨ stop slaveï¼šstop-replica-nice</p>
<pre><code># orchestrator-client -c stop-replica-nice -i test2:3307
test2:3307
</code></pre>
<ol start="42">
<li>æŒ‡å®šå®ä¾‹æ‰§è¡Œå¼€å¯å¤åˆ¶ï¼š start-replica</li>
</ol>
<pre><code># orchestrator-client -c start-replica -i test2:3307
test2:3307
</code></pre>
<ol start="43">
<li>æŒ‡å®šå®ä¾‹æ‰§è¡Œå¤åˆ¶é‡å¯ï¼šrestart-replica</li>
</ol>
<pre><code># orchestrator-client -c restart-replica -i test2:3307
test2:3307
</code></pre>
<ol start="44">
<li>æŒ‡å®šå®ä¾‹æ‰§è¡Œå¤åˆ¶é‡ç½®ï¼šreset-replica</li>
</ol>
<pre><code># orchestrator-client -c reset-replica -i test2:3307
test2:3307
</code></pre>
<ol start="45">
<li>åˆ†ç¦»å‰¯æœ¬ï¼šé GTID ä¿®æ”¹ binlog positionï¼Œdetach-replica ï¼š</li>
</ol>
<pre><code># orchestrator-client -c detach-replica -i test2:3307
</code></pre>
<ol start="46">
<li>æ¢å¤å‰¯æœ¬ï¼šreattach-replica</li>
</ol>
<pre><code># orchestrator-client -c reattach-replica  -i test2:3307 
</code></pre>
<ol start="47">
<li>åˆ†ç¦»å‰¯æœ¬ï¼šæ³¨é‡Š master_host æ¥åˆ†ç¦»ï¼Œdetach-replica-master-host ï¼šå¦‚ Master_Host: //test1</li>
</ol>
<pre><code># orchestrator-client -c detach-replica-master-host -i test2:3307
test2:3307
</code></pre>
<ol start="48">
<li>æ¢å¤å‰¯æœ¬ï¼šreattach-replica-master-host</li>
</ol>
<pre><code># orchestrator-client -c reattach-replica-master-host -i test2:3307
test2:3307
</code></pre>
<ol start="49">
<li>è·³è¿‡ SQL çº¿ç¨‹çš„ Queryï¼Œå¦‚ä¸»é”®å†²çªï¼Œæ”¯æŒåœ¨ GTID å’Œé GTID ä¸‹ï¼šskip-query</li>
</ol>
<pre><code># orchestrator-client -c skip-query -i test2:3307
test2:3307
</code></pre>
<ol start="50">
<li>å°†é”™è¯¯çš„ GTID äº‹åŠ¡å½“åšç©ºäº‹åŠ¡åº”ç”¨å‰¯æœ¬çš„ä¸»ä¸Šï¼šgtid-errant-inject-emptyã€Œweb ä¸Šçš„ fixã€</li>
</ol>
<pre><code># orchestrator-client -c gtid-errant-inject-empty  -i test2:3307
test2:3307 
</code></pre>
<ol start="51">
<li>é€šè¿‡ RESET MASTER åˆ é™¤é”™è¯¯çš„ GTID äº‹åŠ¡ï¼šgtid-errant-reset-master</li>
</ol>
<pre><code># orchestrator-client -c gtid-errant-reset-master  -i test2:3307
test2:3307
</code></pre>
<ol start="52">
<li>è®¾ç½®åŠåŒæ­¥ç›¸å…³çš„å‚æ•°:</li>
</ol>
<pre><code>orchestrator-client -c $variable -i test1:3307
    enable-semi-sync-master      ä¸»ä¸Šæ‰§è¡Œå¼€å¯åŠåŒæ­¥
    disable-semi-sync-master      ä¸»ä¸Šæ‰§è¡Œå…³é—­åŠåŒæ­¥
    enable-semi-sync-replica       ä»ä¸Šæ‰§è¡Œå¼€å¯åŠåŒæ­¥
    disable-semi-sync-replica      ä»ä¸Šæ‰§è¡Œå…³é—­åŠåŒæ­¥
</code></pre>
<ol start="53">
<li>æ‰§è¡Œéœ€è¦ stop/start slave é…åˆçš„ SQLï¼šrestart-replica-statements</li>
</ol>
<pre><code># orchestrator-client -c restart-replica-statements -i test3:3307 -query &quot;change master to auto_position=1&quot; | jq .[] -r 
stop slave io_thread;
stop slave sql_thread;
change master to auto_position=1;
start slave sql_thread;
start slave io_thread;

# orchestrator-client -c restart-replica-statements -i test3:3307 -query &quot;change master to master_auto_position=1&quot; | jq .[] -r  |  mysql -urep -p -htest3 -P3307
Enter password: 
</code></pre>
<ol start="54">
<li>æ ¹æ®å¤åˆ¶è§„åˆ™æ£€æŸ¥å®ä¾‹æ˜¯å¦å¯ä»¥ä»å¦ä¸€ä¸ªå®ä¾‹å¤åˆ¶ (GTID å’Œé GTIDï¼‰ï¼š</li>
</ol>
<p>é GTIDï¼Œcan-replicate-fromï¼š</p>
<pre><code># orchestrator-client -c can-replicate-from -i test3:3307 -d test1:3307
test1:3307
</code></pre>
<p>GTIDï¼šcan-replicate-from-gtid</p>
<pre><code># orchestrator-client -c can-replicate-from-gtid -i test3:3307 -d test1:3307
test1:3307 
</code></pre>
<ol start="55">
<li>æ£€æŸ¥æŒ‡å®šå®ä¾‹æ˜¯å¦åœ¨å¤åˆ¶ï¼šis-replicating</li>
</ol>
<pre><code>#æœ‰è¿”å›åœ¨å¤åˆ¶
# orchestrator-client -c is-replicating -i test2:3307
test2:3307

#æ²¡æœ‰è¿”å›ï¼Œä¸åœ¨å¤åˆ¶
# orchestrator-client -c is-replicating -i test1:3307
</code></pre>
<ol start="56">
<li>æ£€æŸ¥æŒ‡å®šå®ä¾‹çš„ IO å’Œ SQL é™åˆ¶æ˜¯å¦éƒ½åœæ­¢ï¼š</li>
</ol>
<pre><code># orchestrator-client -c is-replicating -i test2:3307
</code></pre>
<ol start="57">
<li>å°†æŒ‡å®šå®ä¾‹è®¾ç½®ä¸ºåªè¯»ï¼Œé€šè¿‡ SET GLOBAL read_only=1ï¼Œset-read-onlyï¼š</li>
</ol>
<pre><code># orchestrator-client -c set-read-only -i test2:3307
test2:3307
</code></pre>
<ol start="58">
<li>å°†æŒ‡å®šå®ä¾‹è®¾ç½®ä¸ºè¯»å†™ï¼Œé€šè¿‡ SET GLOBAL read_only=0ï¼Œset-writeable</li>
</ol>
<pre><code># orchestrator-client -c set-writeable -i test2:3307
test2:3307
</code></pre>
<ol start="59">
<li>è½®è¯¢æŒ‡å®šå®ä¾‹çš„ binary logï¼Œflush-binary-logs</li>
</ol>
<pre><code># orchestrator-client -c flush-binary-logs -i test1:3307
test1:3307
</code></pre>
<ol start="60">
<li>æ‰‹åŠ¨æ‰§è¡Œæ¢å¤ï¼ŒæŒ‡å®šä¸€ä¸ªæ­»æœºçš„å®ä¾‹ï¼Œrecoverï¼š</li>
</ol>
<pre><code># orchestrator-client -c recover -i test2:3307
test3:3307
</code></pre>
<p>æµ‹è¯•ä¸‹æ¥ï¼Œè¯¥å‚æ•°ä¼šè®©å¤„ç†åœæœºæˆ–åˆ™ç»´æŠ¤çŠ¶æ€ä¸‹çš„å®ä¾‹è¿›è¡Œå¼ºåˆ¶æ¢å¤ã€‚ç»“æ„ï¼š</p>
<p>test1:3307 -&gt; test2:3307 -&gt; test3:3307(downtimed) å½“ test2:3307 æ­»æ‰ä¹‹åï¼Œæ­¤æ—¶ test3:3307 å¤„äºåœæœºçŠ¶æ€ï¼Œä¸ä¼šè¿›è¡Œ Failoverï¼Œæ‰§è¡Œåå˜æˆ</p>
<p>test1:3307 -&gt; test2:3307</p>
<p>-&gt; test3:3307</p>
<ol start="61">
<li>ä¼˜é›…çš„è¿›è¡Œä¸»å’ŒæŒ‡å®šä»åˆ‡æ¢ï¼Œgraceful-master-takeoverï¼š</li>
</ol>
<pre><code># orchestrator-client -c graceful-master-takeover -a test1:3307 -d test2:3307
test2:3307
</code></pre>
<p>ç»“æ„ä» test1:3307 -&gt; test2:3307 å˜æˆ test2:3307 -&gt; test1:3307ã€‚æ–°ä¸»æŒ‡å®šå˜æˆè¯»å†™ï¼Œæ–°ä»å˜æˆåªè¯»ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨ start slaveã€‚</p>
<p><strong>æ³¨æ„éœ€è¦é…ç½®ï¼šéœ€è¦ä»å…ƒè¡¨é‡Œæ‰¾åˆ°å¤åˆ¶çš„è´¦å·å’Œå¯†ç ã€‚</strong></p>
<pre><code>&quot;ReplicationCredentialsQuery&quot;:&quot;SELECT repl_user, repl_pass from meta.cluster where anchor=1&quot;
</code></pre>
<ol start="62">
<li>æ‰‹åŠ¨å¼ºåˆ¶æ‰§è¡Œæ¢å¤ï¼Œå³ä½¿ orch æ²¡æœ‰å‘ç°é—®é¢˜ï¼Œforce-master-failoverï¼šè½¬ç§»ä¹‹åè€ä¸»ç‹¬ç«‹ï¼Œéœ€è¦æ‰‹åŠ¨åŠ å…¥åˆ°é›†ç¾¤ã€‚</li>
</ol>
<pre><code># orchestrator-client -c force-master-failover -i test1:3307
test3:3307
</code></pre>
<ol start="63">
<li>å¼ºè¡Œä¸¢å¼ƒ master å¹¶æŒ‡å®šçš„ä¸€ä¸ªå®ä¾‹ï¼Œforce-master-takeoverï¼šè€ä¸» (test1) ç‹¬ç«‹ï¼ŒæŒ‡å®šä» (test2) æå‡ä¸º master</li>
</ol>
<pre><code># orchestrator-client -c force-master-takeover -i test1:3307 -d test2:3307
test2:3307
</code></pre>
<ol start="64">
<li>ç¡®è®¤é›†ç¾¤æ¢å¤ç†ç”±ï¼Œåœ¨ web ä¸Šçš„ Audit-&gt;Recovery-&gt;Acknowledged æŒ‰é’®ç¡®è®¤ï¼Œ/ack-all-recoveries</li>
</ol>
<p>ç¡®è®¤æŒ‡å®šé›†ç¾¤ï¼šack-cluster-recoveries</p>
<pre><code># orchestrator-client -c ack-cluster-recoveries  -i test2:3307 -reason=''
test1:3307
</code></pre>
<p>ç¡®è®¤æ‰€æœ‰é›†ç¾¤ï¼šack-all-recoveries</p>
<pre><code># orchestrator-client -c ack-all-recoveries  -reason='OOOPPP'
eason=XYZ
</code></pre>
<ol start="65">
<li>æ£€æŸ¥ã€ç¦æ­¢ã€å¼€å¯ orchestrator æ‰§è¡Œå…¨å±€æ¢å¤ï¼š</li>
</ol>
<p>æ£€æŸ¥ï¼šcheck-global-recoveries</p>
<pre><code># orchestrator-client -c check-global-recoveries
enabled
</code></pre>
<p>ç¦æ­¢ï¼šdisable-global-recoveries</p>
<pre><code># orchestrator-client -c disable-global-recoveries
disabled
</code></pre>
<p>å¼€å¯ï¼šenable--global-recoveries</p>
<pre><code># orchestrator-client -c enable-global-recoveries
enabled
</code></pre>
<ol start="66">
<li>æ£€æŸ¥åˆ†æå¤åˆ¶æ‹“æ‰‘ä¸­å­˜åœ¨çš„é—®é¢˜ï¼šreplication-analysis</li>
</ol>
<pre><code># orchestrator-client -c replication-analysis
test1:3307 (cluster test1:3307): ErrantGTIDStructureWarning
</code></pre>
<ol start="67">
<li>raft æ£€æµ‹ï¼šleader æŸ¥çœ‹ã€å¥åº·ç›‘æµ‹ã€è¿ç§» leaderï¼š</li>
</ol>
<pre><code>æŸ¥çœ‹leaderèŠ‚ç‚¹
# orchestrator-client -c raft-leader
192.168.163.131:10008

å¥åº·ç›‘æµ‹
# orchestrator-client -c raft-health
healthy

leader ä¸»æœºå
# orchestrator-client -c  raft-leader-hostname 
test1

æŒ‡å®šä¸»æœºé€‰ä¸¾leader
# orchestrator-client -c raft-elect-leader -hostname test3
test3
</code></pre>
<ol start="68">
<li>ä¼ª GTID ç›¸å…³å‚æ•°ï¼š</li>
</ol>
<pre><code>match      #ä½¿ç”¨Pseudo-GTIDæŒ‡å®šä¸€ä¸ªä»åŒ¹é…åˆ°æŒ‡å®šçš„å¦ä¸€ä¸ªï¼ˆç›®æ ‡ï¼‰å®ä¾‹ä¸‹
match-up #Transport the replica one level up the hierarchy, making it child of its grandparent, using Pseudo-GTID
match-up-replicas  #Matches replicas of the given instance one level up the topology, making them siblings of given instance, using Pseudo-GTID
last-pseudo-gtid #Dump last injected Pseudo-GTID entry on a server
</code></pre>
<p>åˆ°æ­¤å…³äº <a href="https://github.com/github/orchestrator">Orchestrator</a> çš„ä½¿ç”¨ä»¥åŠå‘½ä»¤è¡Œè¯´æ˜å·²ç»ä»‹ç»å®Œæ¯•ï¼ŒWeb API å¯ä»¥åœ¨ <a href="https://github.com/github/orchestrator/blob/master/docs/topology-recovery.md#web-api-command-line">Orchestrator API</a> æŸ¥çœ‹ï¼Œé€šè¿‡å‘½ä»¤è¡Œå’Œ API ä¸Šçš„æ“ä½œå¯ä»¥æ›´å¥½çš„è¿›è¡Œè‡ªåŠ¨åŒ–å¼€å‘ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“ï¼š</h2>
<p><a href="https://github.com/github/orchestrator">Orchestrator</a> æ˜¯ä¸€æ¬¾å¼€æº (go ç¼–å†™) çš„ MySQL å¤åˆ¶æ‹“æ‰‘ç®¡ç†å·¥å…·ï¼Œæ”¯æŒ MySQL ä¸»ä»å¤åˆ¶æ‹“æ‰‘å…³ç³»çš„è°ƒæ•´ã€ä¸»åº“æ•…éšœè‡ªåŠ¨åˆ‡æ¢ã€æ‰‹åŠ¨ä¸»ä»åˆ‡æ¢ç­‰åŠŸèƒ½ã€‚æä¾› Web ç•Œé¢å±•ç¤º MySQL é›†ç¾¤çš„æ‹“æ‰‘å…³ç³»åŠçŠ¶æ€ï¼Œå¯ä»¥æ›´æ”¹ MySQL å®ä¾‹çš„éƒ¨åˆ†é…ç½®ä¿¡æ¯ï¼Œä¹Ÿæä¾›å‘½ä»¤è¡Œå’Œ api æ¥å£ã€‚ç›¸å¯¹æ¯” MHAï¼Œ<a href="https://github.com/github/orchestrator">Orchestrator</a> è‡ªèº«å¯ä»¥éƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡ raft åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®æ¥ä¿è¯è‡ªèº«çš„é«˜å¯ç”¨ã€‚</p>

          
          <p class="next-post">ä¸‹ä¸€ç¯‡ï¼š
            <a href="https://jwangkun.github.io/wD_JHQNwi/">
              <span class="post-title">
                MySQL é«˜å¯ç”¨å¤åˆ¶ç®¡ç†å·¥å…· â€”â€” Orchestrator ä»‹ç»&rarr;
              </span>
            </a>
          </p>
        
        <div class="comment">
          
        </div>
      </div>
    </div>
  </article>
 <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li class="list-inline-item">
              <a href="https://jwangkun.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li>
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>John Wong&#39;s Blog</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://jwangkun.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://jwangkun.github.io/media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>â–²</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));
  var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?84ab85460bfbe79dbe5776a1df139a8f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
  </script>
  
<script type="text/javascript" src="https://v1.cnzz.com/z_stat.php?id=1279350888&web_id=1279350888"></script>

  </body>
</html>

