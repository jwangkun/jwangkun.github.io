<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="yes" name="apple-mobile-web-app-capable" />
  <meta content="black" name="apple-mobile-web-app-status-bar-style" />
  <meta name="referrer" content="never">
  <meta name="keywords" content="">
  <meta name="description" content="">
  <meta name="author" content="kveln">
  <title>部署 Mariadb HA 环境 | John Wong&#39;s Blog</title>
  <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <!-- <link href="https://jwangkun.github.io/media/css/bootstrap.min.css" rel="stylesheet"> -->
  <!--  <link href="https://jwangkun.github.io/media/css/all.min.css" rel="stylesheet" type="text/css"> -->
  <link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
  <link rel="alternate" type="application/rss+xml" title="部署 Mariadb HA 环境 | John Wong&#39;s Blog » Feed" href="https://jwangkun.github.io/atom.xml">
  <link rel="stylesheet"href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
  <link href="https://jwangkun.github.io/styles/main.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/highlight.min.js"></script>
  <!-- <script src="https://jwangkun.github.io/media/scripts/jquery.min.js"></script> -->
  <script>hljs.initHighlightingOnLoad();</script>
  

    <meta property="og:description" content="部署 Mariadb HA 环境"/>
    <meta property="og:url" content="https://jwangkun.github.io/n8NIXj7Rj/"/>
    <meta property="og:locale" content="zh-CN"/>
    <meta property="og:type" content="website"/>
    <meta property="og:site_name" content="John Wong&#39;s Blog"/>
  </head>
  <body>
  	<!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="https://jwangkun.github.io">John Wong&#39;s Blog</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          
          <li class="nav-item">
              
              <a class="nav-link" href="/">首页</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/archives">归档</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
          </li>
          
          <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
          </li>
          
        </ul>
      </div>
    </div>
  </nav>
  <!-- Page Header -->
  <header class="masthead" style="background-image: url('https://jwangkun.github.io/media/images/home-bg.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
          	<span class="tags">
          	 
            <a href="https://jwangkun.github.io/0xeHLkj9N/" class="tag">Mariadb</a>
            
            <a href="https://jwangkun.github.io/zHmUTTHTlQ/" class="tag">数据库集群</a>
            
        </span>
            <h1>部署 Mariadb HA 环境</h1>
            <span class="meta">
            	Posted on
              2021-11-08，8 min read
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <p>部署<br>
keepalived 的主要作用是为 Mariadb 提供 vip，在2个 Mariadb 实例之间切换，不间断的提供服务。</p>
<p>部署配置 Mariadb 主主复制<br>
安装并启动 Mariadb</p>
<p>$ yum install -y mariadb-server<br>
$ systemctl enable --now mariadb<br>
运行 Mariadb 安全配置向导，设置密码等</p>
<p>$ mysql_secure_installation<br>
... ...<br>
Change the root password? [Y/n] y<br>
New password:<br>
Re-enter new password:<br>
Password updated successfully!<br>
Reloading privilege tables..<br>
... Success!<br>
... ...<br>
Remove anonymous users? [Y/n] y<br>
... Success!<br>
... ...<br>
Disallow root login remotely? [Y/n] y<br>
... Success!<br>
... ...<br>
Remove test database and access to it? [Y/n] y</p>
<ul>
<li>Dropping test database...<br>
... Success!</li>
<li>Removing privileges on test database...<br>
... Success! ... ...<br>
Reload privilege tables now? [Y/n] y<br>
... Success!<br>
... ...<br>
修改 Mariadb 配置文件，准备配置主主复制</li>
</ul>
<h1 id="主节点">主节点</h1>
<p>$ cat &lt;<EOF > /etc/my.cnf<br>
[mysqld]<br>
datadir=/var/lib/mysql<br>
socket=/var/lib/mysql/mysql.sock</p>
<h1 id="disabling-symbolic-links-is-recommended-to-prevent-assorted-security-risks">Disabling symbolic-links is recommended to prevent assorted security risks</h1>
<p>symbolic-links=0</p>
<h1 id="settings-user-and-group-are-ignored-when-systemd-is-used">Settings user and group are ignored when systemd is used.</h1>
<h1 id="if-you-need-to-run-mysqld-under-a-different-user-or-group">If you need to run mysqld under a different user or group,</h1>
<h1 id="customize-your-systemd-unit-file-for-mariadb-according-to-the">customize your systemd unit file for mariadb according to the</h1>
<h1 id="instructions-in-httpfedoraprojectorgwikisystemd">instructions in http://fedoraproject.org/wiki/Systemd</h1>
<h1 id="skip-domain-name-resolve">skip domain name resolve</h1>
<p>skip_name_resolve</p>
<h1 id="auto-delete-binlog-older-than-30-days">auto delete binlog older than 30 days</h1>
<p>expire_logs_days=30<br>
innodb_file_per_table=ON<br>
max_connections = 300<br>
max_allowed_packet=20M</p>
<p>server-id = 1<br>
auto_increment_offset = 1<br>
auto_increment_increment = 2<br>
log-bin = mysql-bin<br>
binlog-format = row<br>
log-slave-updates<br>
max_binlog_size = 1G<br>
replicate-ignore-db = information_schema<br>
replicate-ignore-db = performance_schema<br>
max_connections = 1000<br>
max_connect_errors = 0<br>
max_allowed_packet = 1G<br>
slave-net-timeout=10<br>
master-retry-count=0</p>
<p>slow_query_log = 1<br>
long_query_time = 2<br>
slow_query_log_file = /var/log/mariadb/slow-query.log</p>
<p>[mysql]<br>
no-auto-rehash</p>
<p>[mysqld_safe]<br>
log-error=/var/log/mariadb/mariadb.log<br>
pid-file=/var/run/mariadb/mariadb.pid</p>
<h1 id=""></h1>
<h1 id="include-all-files-from-the-config-directory">include all files from the config directory</h1>
<h1 id="-2"></h1>
<p>!includedir /etc/my.cnf.d<br>
EOF</p>
<h1 id="备节点">备节点</h1>
<p>$ cat &lt;<EOF > /etc/my.cnf<br>
[mysqld]<br>
datadir=/var/lib/mysql<br>
socket=/var/lib/mysql/mysql.sock</p>
<h1 id="disabling-symbolic-links-is-recommended-to-prevent-assorted-security-risks-2">Disabling symbolic-links is recommended to prevent assorted security risks</h1>
<p>symbolic-links=0</p>
<h1 id="settings-user-and-group-are-ignored-when-systemd-is-used-2">Settings user and group are ignored when systemd is used.</h1>
<h1 id="if-you-need-to-run-mysqld-under-a-different-user-or-group-2">If you need to run mysqld under a different user or group,</h1>
<h1 id="customize-your-systemd-unit-file-for-mariadb-according-to-the-2">customize your systemd unit file for mariadb according to the</h1>
<h1 id="instructions-in-httpfedoraprojectorgwikisystemd-2">instructions in http://fedoraproject.org/wiki/Systemd</h1>
<h1 id="skip-domain-name-resolve-2">skip domain name resolve</h1>
<p>skip_name_resolve</p>
<h1 id="auto-delete-binlog-older-than-30-days-2">auto delete binlog older than 30 days</h1>
<p>expire_logs_days=30<br>
innodb_file_per_table=ON<br>
max_connections = 300<br>
max_allowed_packet=20M</p>
<p>server-id = 2<br>
auto_increment_offset = 2<br>
auto_increment_increment = 2<br>
log-bin = mysql-bin<br>
binlog-format = row<br>
log-slave-updates<br>
max_binlog_size = 1G<br>
replicate-ignore-db = information_schema<br>
replicate-ignore-db = performance_schema<br>
max_connections = 1000<br>
max_connect_errors = 0<br>
max_allowed_packet = 1G<br>
slave-net-timeout=10<br>
master-retry-count=0</p>
<p>slow_query_log = 1<br>
long_query_time = 2<br>
slow_query_log_file = /var/log/mariadb/slow-query.log</p>
<p>[mysql]<br>
no-auto-rehash</p>
<p>[mysqld_safe]<br>
log-error=/var/log/mariadb/mariadb.log<br>
pid-file=/var/run/mariadb/mariadb.pid</p>
<h1 id="-3"></h1>
<h1 id="include-all-files-from-the-config-directory-2">include all files from the config directory</h1>
<h1 id="-4"></h1>
<p>!includedir /etc/my.cnf.d<br>
EOF</p>
<h1 id="重启服务">重启服务</h1>
<p>$ systemctl restart mariadb<br>
主节点创建只读账号，导出全部数据，导入备节点。记录binlog日志文件名和position。</p>
<h1 id="以下命令在主节点执行">以下命令在主节点执行</h1>
<h1 id="此密码为上面设置的-mariadb-root-密码为了方便只读账号也使用此密码">此密码为上面设置的 Mariadb root 密码，为了方便，只读账号也使用此密码</h1>
<p>$ MYSQL_PASSWD='your-sql-passwd'</p>
<h1 id="开启-mariadb-的远程访问">开启 Mariadb 的远程访问</h1>
<p>$ mysql -uroot -p<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>Y</mi><mi>S</mi><mi>Q</mi><msub><mi>L</mi><mi>P</mi></msub><mi>A</mi><mi>S</mi><mi>S</mi><mi>W</mi><mi>D</mi><mo>−</mo><mi>e</mi><mi mathvariant="normal">&quot;</mi><mi>G</mi><mi>R</mi><mi>A</mi><mi>N</mi><mi>T</mi><mi>A</mi><mi>L</mi><mi>L</mi><mi>P</mi><mi>R</mi><mi>I</mi><mi>V</mi><mi>I</mi><mi>L</mi><mi>E</mi><mi>G</mi><mi>E</mi><mi>S</mi><mi>O</mi><mi>N</mi><mo>∗</mo><mi mathvariant="normal">.</mi><mo>∗</mo><mi>T</mi><msup><mi>O</mi><mo mathvariant="normal">′</mo></msup><mi>r</mi><mi>o</mi><mi>o</mi><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup><msup><mi mathvariant="normal">@</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">MYSQL_PASSWD -e &quot;GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">Q</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">e</span><span class="mord">&quot;</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">A</span><span class="mord mathdefault">L</span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord">.</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">o</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">@</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>MYSQL_PASSWD' WITH GRANT OPTION;FLUSH PRIVILEGES&quot;</p>
<h1 id="创建只读账号">创建只读账号</h1>
<p>$ mysql -u root -p<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>Y</mi><mi>S</mi><mi>Q</mi><msub><mi>L</mi><mi>P</mi></msub><mi>A</mi><mi>S</mi><mi>S</mi><mi>W</mi><mi>D</mi><mo>−</mo><mi>e</mi><mi mathvariant="normal">&quot;</mi><mi>G</mi><mi>R</mi><mi>A</mi><mi>N</mi><mi>T</mi><mi>R</mi><mi>E</mi><mi>P</mi><mi>L</mi><mi>I</mi><mi>C</mi><mi>A</mi><mi>T</mi><mi>I</mi><mi>O</mi><mi>N</mi><mi>S</mi><mi>L</mi><mi>A</mi><mi>V</mi><mi>E</mi><mi>O</mi><mi>N</mi><mo>∗</mo><mi mathvariant="normal">.</mi><mo>∗</mo><mi>T</mi><mi>O</mi><mi>r</mi><mi>e</mi><mi>p</mi><mi>l</mi><msup><mi mathvariant="normal">@</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">MYSQL_PASSWD -e &quot;GRANT REPLICATION SLAVE ON *.* TO repl@&#x27;%&#x27; IDENTIFIED BY &#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">Q</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">e</span><span class="mord">&quot;</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">L</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord">.</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord">@</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>MYSQL_PASSWD';FLUSH PRIVILEGES&quot;</p>
<h1 id="示例是全新安装的-mariadb-还没有使用-如果是正在使用的数据库做主主复制需要锁表后再导出数据">示例是全新安装的 Mariadb ，还没有使用。如果是正在使用的数据库做主主复制，需要锁表后再导出数据</h1>
<p>$ mysql -uroot -p$MYSQL_PASSWD -e &quot;SHOW PROCESSLIST&quot;<br>
+----+------+-----------+------+---------+------+-------+------------------+----------+<br>
| Id | User | Host      | db   | Command | Time | State | Info             | Progress |<br>
+----+------+-----------+------+---------+------+-------+------------------+----------+<br>
|  4 | root | localhost | NULL | Query   |    0 | NULL  | SHOW PROCESSLIST |    0.000 |<br>
+----+------+-----------+------+---------+------+-------+------------------+----------+</p>
<h1 id="记录binlog日志文件名和position">记录binlog日志文件名和position</h1>
<p>$ mysql -u root -p$MYSQL_PASSWD -e &quot;SHOW MASTER STATUS\G&quot;<br>
*************************** 1. row ***************************<br>
File: mysql-bin.000001<br>
Position: 2023<br>
Binlog_Do_DB:<br>
Binlog_Ignore_DB:</p>
<h1 id="导出全部数据">导出全部数据</h1>
<p>$ mysqldump --all-databases -p$MYSQL_PASSWD &gt; alldb.db</p>
<h1 id="拷贝-alldbdb-到备节点">拷贝 alldb.db 到备节点</h1>
<p>$ scp alldb.db db2:/root/</p>
<h1 id="以下命令在备节点执行">以下命令在备节点执行</h1>
<h1 id="此密码为上面设置的-mariadb-root-密码">此密码为上面设置的 Mariadb root 密码</h1>
<p>$ MYSQL_PASSWD='your-sql-passwd'</p>
<h1 id="导入主节点导出的数据">导入主节点导出的数据</h1>
<p>mysql -u root -p$MYSQL_PASSWD &lt; alldb.db</p>
<h1 id="重载权限">重载权限</h1>
<p>mysql -u root -p$MYSQL_PASSWD -e &quot;FLUSH PRIVILEGES&quot;</p>
<h1 id="记录binlog日志文件名和position-2">记录binlog日志文件名和position</h1>
<p>mysql -u root -p$MYSQL_PASSWD -e &quot;SHOW MASTER STATUS\G&quot;<br>
*************************** 1. row ***************************<br>
File: mysql-bin.000001<br>
Position: 509778<br>
Binlog_Do_DB:<br>
Binlog_Ignore_DB:<br>
设置主主复制</p>
<h1 id="以下命令在主节点执行-2">以下命令在主节点执行</h1>
<h1 id="修改master_host为备节点ip修改master_log_file和master_log_pos为上面备节点记录的信息">修改MASTER_HOST为备节点IP，修改MASTER_LOG_FILE和MASTER_LOG_POS为上面备节点记录的信息</h1>
<p>mysql -u root -p<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>Y</mi><mi>S</mi><mi>Q</mi><msub><mi>L</mi><mi>P</mi></msub><mi>A</mi><mi>S</mi><mi>S</mi><mi>W</mi><mi>D</mi><mo>−</mo><mi>e</mi><mi mathvariant="normal">&quot;</mi><mi>C</mi><mi>H</mi><mi>A</mi><mi>N</mi><mi>G</mi><mi>E</mi><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><mi>R</mi><mi>T</mi><mi>O</mi><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><msub><mi>R</mi><mi>H</mi></msub><mi>O</mi><mi>S</mi><mi>T</mi><msup><mo>=</mo><mo mathvariant="normal">′</mo></msup><mn>192.168.199.9</mn><msup><mn>9</mn><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><msub><mi>R</mi><mi>U</mi></msub><mi>S</mi><mi>E</mi><mi>R</mi><msup><mo>=</mo><mo mathvariant="normal">′</mo></msup><mi>r</mi><mi>e</mi><mi>p</mi><msup><mi>l</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><msub><mi>R</mi><mi>P</mi></msub><mi>A</mi><mi>S</mi><mi>S</mi><mi>W</mi><mi>O</mi><mi>R</mi><mi>D</mi><msup><mo>=</mo><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">MYSQL_PASSWD -e &quot;CHANGE MASTER TO MASTER_HOST=&#x27;192.168.199.99&#x27;,MASTER_USER=&#x27;repl&#x27;,MASTER_PASSWORD=&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">Q</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.901892em;vertical-align:-0.15em;"></span><span class="mord mathdefault">e</span><span class="mord">&quot;</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">9</span><span class="mord">2</span><span class="mord">.</span><span class="mord">1</span><span class="mord">6</span><span class="mord">8</span><span class="mord">.</span><span class="mord">1</span><span class="mord">9</span><span class="mord">9</span><span class="mord">.</span><span class="mord">9</span><span class="mord"><span class="mord">9</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">p</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>MYSQL_PASSWD',MASTER_PORT=3306,MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=509778,MASTER_CONNECT_RETRY=2;START SLAVE&quot;</p>
<h1 id="以下命令在备节点执行-2">以下命令在备节点执行</h1>
<h1 id="修改master_host为主节点ip修改master_log_file和master_log_pos为上面主节点记录的信息">修改MASTER_HOST为主节点IP，修改MASTER_LOG_FILE和MASTER_LOG_POS为上面主节点记录的信息</h1>
<p>mysql -u root -p<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mi>Y</mi><mi>S</mi><mi>Q</mi><msub><mi>L</mi><mi>P</mi></msub><mi>A</mi><mi>S</mi><mi>S</mi><mi>W</mi><mi>D</mi><mo>−</mo><mi>e</mi><mi mathvariant="normal">&quot;</mi><mi>C</mi><mi>H</mi><mi>A</mi><mi>N</mi><mi>G</mi><mi>E</mi><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><mi>R</mi><mi>T</mi><mi>O</mi><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><msub><mi>R</mi><mi>H</mi></msub><mi>O</mi><mi>S</mi><mi>T</mi><msup><mo>=</mo><mo mathvariant="normal">′</mo></msup><mn>192.168.199.9</mn><msup><mn>8</mn><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><msub><mi>R</mi><mi>U</mi></msub><mi>S</mi><mi>E</mi><mi>R</mi><msup><mo>=</mo><mo mathvariant="normal">′</mo></msup><mi>r</mi><mi>e</mi><mi>p</mi><msup><mi>l</mi><mo mathvariant="normal">′</mo></msup><mo separator="true">,</mo><mi>M</mi><mi>A</mi><mi>S</mi><mi>T</mi><mi>E</mi><msub><mi>R</mi><mi>P</mi></msub><mi>A</mi><mi>S</mi><mi>S</mi><mi>W</mi><mi>O</mi><mi>R</mi><mi>D</mi><msup><mo>=</mo><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">MYSQL_PASSWD -e &quot;CHANGE MASTER TO MASTER_HOST=&#x27;192.168.199.98&#x27;,MASTER_USER=&#x27;repl&#x27;,MASTER_PASSWORD=&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">Q</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.901892em;vertical-align:-0.15em;"></span><span class="mord mathdefault">e</span><span class="mord">&quot;</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">9</span><span class="mord">2</span><span class="mord">.</span><span class="mord">1</span><span class="mord">6</span><span class="mord">8</span><span class="mord">.</span><span class="mord">1</span><span class="mord">9</span><span class="mord">9</span><span class="mord">.</span><span class="mord">9</span><span class="mord"><span class="mord">8</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">p</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>MYSQL_PASSWD',MASTER_PORT=3306,MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=2023,MASTER_CONNECT_RETRY=2;START SLAVE&quot;</p>
<h1 id="主备都执行验证同步状态都输出2个-yes-表示正常">主备都执行，验证同步状态，都输出2个 Yes 表示正常</h1>
<p>mysql -u root -p$MYSQL_PASSWD -e &quot;SHOW SLAVE STATUS\G&quot; | grep Running<br>
Slave_IO_Running: Yes<br>
Slave_SQL_Running: Yes<br>
至此，DB 主主复制部署完成，可以测试在任一节点进行数据库操作，另一节点验证。不过对外提供服务还是需要通过 vip，不然发生切换还需要业务端切换 ip，下面配置 keepalived 对外提供服务。</p>
<p>部署配置 keepalived<br>
设置相关的环境变量，根据不同的环境自行配置。</p>
<h1 id="keepalived-vip-地址">keepalived vip 地址</h1>
<p>export DB_VIP=192.168.199.97</p>
<h1 id="keepalived-auth-toke">keepalived auth toke</h1>
<p>export DBHA_KA_AUTH=onecloud</p>
<h1 id="keepalived-network-interface">keepalived network interface</h1>
<p>export DB_NETIF=eth0<br>
设置 sysctl 选项</p>
<p>$ cat &lt;<EOF >&gt;/etc/sysctl.conf<br>
net.ipv4.ip_forward = 1<br>
net.ipv4.ip_nonlocal_bind = 1<br>
EOF</p>
<p>$ sysctl -p<br>
安装 keepalived nc</p>
<p>$ yum install -y keepalived nc<br>
添加配置</p>
<h1 id="请确保-virtual_router_id-不会和局域网内的其他-keepalived-集群冲突">请确保 virtual_router_id 不会和局域网内的其他 keepalived 集群冲突</h1>
<p>$ cat &lt;<EOF >/etc/keepalived/keepalived.conf<br>
global_defs {<br>
router_id onecloud<br>
}</p>
<p>vrrp_script chk_mysql {<br>
script &quot;/etc/keepalived/chk_mysql&quot;<br>
interval 1<br>
}</p>
<p>vrrp_instance VI_1 {<br>
state MASTER<br>
interface $DB_NETIF<br>
virtual_router_id 99<br>
priority 100<br>
advert_int 1<br>
nopreempt<br>
authentication {<br>
auth_type PASS<br>
auth_pass $DBHA_KA_AUTH<br>
}</p>
<pre><code>track_script {
    chk_mysql
}

virtual_ipaddress {
    $DB_VIP
}
</code></pre>
<p>}<br>
EOF</p>
<p>$ cat &lt;<EOF > /etc/keepalived/chk_mysql<br>
#!/bin/bash<br>
echo | nc 127.0.0.1 3306 &amp;&gt;/dev/null<br>
EOF</p>
<p>$ chmod +x /etc/keepalived/chk_mysql<br>
启动 keepalived</p>
<p>$ systemctl enable --now keepalived<br>
$ ip addr show $DB_NETIF<br>
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>
link/ether 00:22:cf:40:1e:29 brd ff:ff:ff:ff:ff:ff<br>
inet 192.168.199.99/24 brd 192.168.199.255 scope global dynamic eth0<br>
valid_lft 100651906sec preferred_lft 100651906sec<br>
inet 192.168.199.97/32 scope global eth0<br>
valid_lft forever preferred_lft forever<br>
inet6 fe80::222:cfff:fe40:1e29/64 scope link<br>
valid_lft forever preferred_lft forever<br>
至此，DB 高可用部署完成，任一节点的 Mariadb 或 keepalived 服务异常，或者任一节点宕机，都不影响对外服务。</p>

          
          <p class="next-post">下一篇：
            <a href="https://jwangkun.github.io/ooWpkTMio/">
              <span class="post-title">
                部署 HA 环境&rarr;
              </span>
            </a>
          </p>
        
        <div class="comment">
          
        </div>
      </div>
    </div>
  </article>
 <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li class="list-inline-item">
              <a href="https://jwangkun.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li>
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>John Wong&#39;s Blog</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://jwangkun.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://jwangkun.github.io/media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>▲</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));
  var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?84ab85460bfbe79dbe5776a1df139a8f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
  </script>
  
<script type="text/javascript" src="https://v1.cnzz.com/z_stat.php?id=1279350888&web_id=1279350888"></script>

  </body>
</html>

